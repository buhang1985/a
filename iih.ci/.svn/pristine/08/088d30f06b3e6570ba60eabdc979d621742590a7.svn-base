/**
 * 
 */
package iih.ci.ord.s.bp.assi.gj;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;

import iih.bd.bc.param.IBdMmParamValueConst;
import iih.bd.bc.udi.pub.IBdFcDictCodeConst;
import iih.bd.bc.udi.pub.IBdSrvDictCodeConst;
import iih.bd.bc.udi.pub.ICiDictCodeConst;
import iih.bd.fc.orwf.d.OrWfExDeptDTO;
import iih.bd.mm.meterial.d.MMPackageUnitDO;
import iih.bd.mm.meterial.d.MeterialAggDO;
import iih.bd.mm.meterial.d.MeterialDO;
import iih.bd.mm.meterial.d.desc.MeterialDODesc;
import iih.bd.srv.cherbboilmd.d.CHerbBoilDesDO;
import iih.bd.srv.cherbboilmd.d.CHerbBoilMdDO;
import iih.bd.srv.cherbboilmd.i.ICHerbBoilDesDORService;
import iih.bd.srv.cherbboilmd.i.ICherbboilmdMDORService;
import iih.bd.srv.ems.d.SrvMatchEmsRstDTO;
import iih.bd.srv.freqdef.d.FreqDefDO;
import iih.bd.srv.freqdef.i.IFreqdefMDORService;
import iih.bd.srv.medsrv.d.MedSrvDO;
import iih.bd.srv.medsrv.d.MedSrvDrugDO;
import iih.bd.srv.medsrv.d.MedSrvPriceDO;
import iih.bd.srv.medsrv.d.MedSrvRisDO;
import iih.bd.srv.medsrv.d.MedSrvSetItemDO;
import iih.bd.srv.medsrv.i.IMedSrvRisDORService;
import iih.bd.srv.medsrv.i.IMedSrvSetItemDORService;
import iih.bd.srv.medsrv.i.IMedsrvMDORService;
import iih.bd.srv.medusage.d.MedUsageDO;
import iih.bd.srv.medusage.d.MedUsageDesDO;
import iih.bd.srv.medusage.i.IMedusageRService;
import iih.bd.srv.medusage.i.IMedusagedesRService;
import iih.bd.utils.BdMmParamUtils;
import iih.bd.utils.ParamUtils;
import iih.ci.diag.cidiag.d.CiDiagItemDO;
import iih.ci.diag.cidiag.i.ICiDiagItemDORService;
import iih.ci.diag.i.ICidiagQryService;
import iih.ci.ord.ciordems.d.EmsType;
import iih.ci.ord.ciorder.d.HpBeyondEnum;
import iih.ci.ord.ciorder.d.HpIndicJudgeEnum;
import iih.ci.ord.ciorder.d.OrSourceFromEnum;
import iih.ci.ord.ciorder.d.OrSrvSourceFromEnum;
import iih.ci.ord.ems.d.CiEmsDTO;
import iih.ci.ord.ems.d.CiEmsSrvDTO;
import iih.ci.ord.ems.d.CiEnContextDTO;
import iih.ci.ord.emsdi.d.OrWfDeptInfoDTO;
import iih.ci.ord.i.ICiOrdCustomSysParamConst;
import iih.ci.ord.moreemsdto.d.MoreEmsParamDTO;
import iih.ci.ord.ordsrvset.d.OrdSrvSetDO;
import iih.ci.ord.pub.CiOrdAppUtils;
import iih.ci.ord.pub.CiOrdUtils;
import iih.ci.ord.pub.util.biz.CiEnContextUtil;
import iih.ci.ord.pub.util.tools.MessageConvertUtil;
import iih.ci.ord.s.bp.ems.CiEmsDefaultValueSetBP;
import iih.ci.ord.s.bp.emscalculate.total.CalTimesCurBP;
import iih.ci.ord.s.bp.quantum.CalDtEffeBP;
import iih.ci.ord.s.bp.quantum.CalQuantumBP;
import iih.ci.ord.s.bp.quantum.times.GetTotalTimesBP;
import iih.ci.ord.s.bp.srvpri.CiOrBdSrvPricesCalByPriModeBP;
import iih.ci.ord.s.bp.validate.chain.AssembleAssiChain;
import iih.ci.ord.s.bp.validate.chain.ValidateDataDTO;
import iih.ci.ord.s.ems.cache.BDMmDoseUnitInfoCache;
import iih.ci.ord.s.ems.define.ICiDoctorStationTypeConst;
import iih.ci.ord.s.ems.log.OrdBizLogger;
import iih.ci.ord.s.ems.meta.DiagOutlineInfo;
import iih.ci.ord.s.ems.utils.DeptInfoUtils;
import iih.ci.ord.s.ems.utils.DiagInfoUtils;
import iih.ci.ord.s.utils.GetDrugDaysOfAvailable;
import iih.ci.ord.s.utils.GetDrugTotalQuan4DoseBP;
import iih.ci.ord.srvpri.d.BdSrvPriCalParamDTO;
import iih.ci.ord.tmpl.d.CiOrTmplDTO;
import iih.ci.ord.tmpl.d.CiOrTmplSrvDTO;
import iih.mm.itf.material.d.GetStockReqDTO;
import iih.mm.itf.material.d.MaterialStatus;
import iih.mm.itf.material.d.MaterialStockDTO;
import iih.mm.itf.material.i.IMaterialStockService;
import iih.mm.itf.materialunitdto.d.MaterialUnitDTO;
import xap.mw.core.data.BizException;
import xap.mw.core.data.BizRuntimeException;
import xap.mw.core.data.Context;
import xap.mw.core.data.DOStatus;
import xap.mw.core.data.FArrayList;
import xap.mw.core.data.FMap;
import xap.mw.core.data.FMap2;
import xap.mw.coreitf.d.FBoolean;
import xap.mw.coreitf.d.FDateTime;
import xap.mw.coreitf.d.FDouble;
import xap.mw.sf.core.util.ServiceFinder;
import xap.sys.appfw.orm.utils.AppFwUtil;
import xap.sys.jdbc.facade.DAFacade;
import xap.sys.jdbc.handler.BeanHandler;
import xap.sys.jdbc.handler.ColumnListHandler;
import xap.sys.xbd.measdoc.d.MeasDocDO;
import xap.sys.xbd.paramset.i.ParamsetQryUtil;

/**
 * @ClassName: CiOrTmplAggDTOMappingCiEmsDTO
 * @Description: åŒ»å˜±æ¨¡æ¿æ˜ æˆCiEmsDTO
 * @author Comsys-li_zheng
 * @date 2016å¹?æœ?æ—?ä¸‹åˆ2:55:36
 * @Package iih.ci.ord.s.bp.assi Copyright: Copyright (c) 2011 Company:
 *          åŒ—å¤§åŒ»ç–—ä¿¡æ¯æŠ€æœ¯æœ‰é™è´£ä»»å…¬å?
 */
public class CiOrTmplAggDTOMappingCiEmsDTO {

	// é¢‘æ¬¡
	private IFreqdefMDORService ifreqdefMDORService;
	// ç”¨æ³•
	private IMedusageRService imedusageRService;
	// ç”¨æ³•è¦æ±‚
	private IMedusagedesRService imedusagedesRService;
	// ç…æ³•
	private ICherbboilmdMDORService icherbboilmdMDORService;
	// ç…æ³•è¦æ±‚
	private ICHerbBoilDesDORService icHerbBoilDesDORService;
	// åŒ»ç–—æœåŠ¡æœåŠ¡
	private IMedsrvMDORService imedsrvMDORService;
	// å¥—å®šä¹‰æœåŠ?
	private IMedSrvSetItemDORService srvSetItemRSercie;
	// æ£€æŸ¥å±æ€?
	private IMedSrvRisDORService imedSrvRisDORService = null;
	// è¯Šæ–­æœåŠ¡æ¥å£
	private ICidiagQryService icidiagQryService;

	// å¥—å†…é¡¹ç›®å¯¹åº”çš„æœåŠ¡mapç»“æ„(æ¯ä¸ªå¥—å†…é¡¹ç›®å¯¹åº”mapä¸­ä¸€æ¡è®°å½•ï¼Œkeyï¼šå¯¹åº”bd_srvä¸­çš„id_srv)
	private Map<String, MedSrvSetItemDO> setItemSrvMap = null;
	// æœåŠ¡å¥—idä¸å¥—å†…é¡¹ç›®é›†åˆMapç»“æ„ï¼ˆkeyæœåŠ¡å¥—çš„id_srv ï¼Œvalue å¥—å†…é¡¹ç›®é›†åˆï¼?
	private Map<String, List<MedSrvSetItemDO>> srvSetItemsMap = null;
	// æ£€æŸ¥å±æ€?
	private Map<String, MedSrvRisDO> srvRisMap = null;
	// bd_srv
	private Map<String, MedSrvDO> bdSrvMap = null;
	// è®¡ç®—æ€»æ¬¡æ•?
	private CalTimesCurBP calTimesCurBP;

	// æ˜ å°„åˆå§‹åŒ–æ—¶CiEmsä¸éšåŒ»å˜±å˜åŒ–çš„å±æ€§å¯¹è±?
	private InitMappingCiEmsProperty mappingProperty;
	// å•†å“æ¨¡å¼
	// 1. å•†å“åæ¨¡å¼æ—¶ï¼Œå¹¶ä¸”æœåŠ¡æ˜¯å¼€ç«‹ç»‘å®šï¼Œåˆ¤æ–­è¯å“çš„å¯ä½¿ç”¨æ ‡è¯†ï¼Œæ‰§è¡Œç»‘å®šä¸éœ€è¦åˆ¤æ–­å•†å“ç›¸å…³é€»è¾‘ï¼Œåœç”¨ï¼Œåœå¼€ï¼Œå¯ä½¿ç”¨æ ‡è¯†
	// 2. é€šç”¨åæ¨¡å¼ï¼Œå¼€ç«‹ç»‘å®šä¸éœ€è¦åˆ¤æ–­å•†å“çš„å¯ä½¿ç”¨æ ‡è¯†ï¼Œéœ€è¦åˆ¤æ–­è¯å“åœç”¨ï¼Œåœå¼€ã€‚æ‰§è¡Œç»‘å®šä¸éœ€è¦åˆ¤æ–­å•†å“ç›¸å…³é€»è¾‘ï¼Œåœç”¨ï¼Œåœå¼€ï¼Œå¯ä½¿ç”¨æ ‡è¯†
	private String drugManagementModel;
	// 1. å•†å“åæ¨¡å¼æ—¶ï¼Œå¹¶ä¸”æœåŠ¡æ˜¯å¼€ç«‹ç»‘å®šï¼Œåˆ¤æ–­è¯å“çš„å¯ä½¿ç”¨æ ‡è¯†ï¼Œæ‰§è¡Œç»‘å®šä¸éœ€è¦åˆ¤æ–­å•†å“ç›¸å…³é€»è¾‘ï¼Œåœç”¨ï¼Œåœå¼€ï¼Œå¯ä½¿ç”¨æ ‡è¯†
	// 2. é€šç”¨åæ¨¡å¼ï¼Œå¼€ç«‹ç»‘å®šä¸éœ€è¦åˆ¤æ–­å•†å“çš„å¯ä½¿ç”¨æ ‡è¯†ï¼Œéœ€è¦åˆ¤æ–­è¯å“åœç”¨ï¼Œåœå¼€ã€‚æ‰§è¡Œç»‘å®šä¸éœ€è¦åˆ¤æ–­å•†å“ç›¸å…³é€»è¾‘ï¼Œåœç”¨ï¼Œåœå¼€ï¼Œå¯ä½¿ç”¨æ ‡è¯†
	// é€šç”¨ååœ¨æŸ¥è¯¢è¯­å¥ä¸­è¿‡æ»¤ç‰©å“æ˜¯å¦å¯ç”?
	// é—¨è¯Šä½é™¢çš„å¯ä½¿ç”¨çŠ¶æ€å¯¹åº”å…³ç³»ï¼Œç”¨äºè¿‡æ»¤å½“å‰å°±è¯Šç¯å¢ƒä¸‹æ˜¯å¦æ”¯æŒæ¨¡æ¿è½¬æ¢ä¸ºåŒ»å˜±
	// key å°±è¯Šç±»å‹ value å¯ä½¿ç”¨æ ‡è¯†å­—æ®µåç§?
	private final static Map<String, String> FG_USE_MAP = new HashMap<String, String>() {
		{
			put(IBdFcDictCodeConst.SD_CODE_ENTP_OP, "get" + MedSrvDO.FG_USE_OP); // å¯ä½¿ç”¨æ ‡è¯†_é—¨è¯Š
			put(IBdFcDictCodeConst.SD_CODE_ENTP_PE, "get" + MedSrvDO.FG_USE_PE); // å¯ä½¿ç”¨æ ‡è¯†_ä½“æ£€
			put(IBdFcDictCodeConst.SD_CODE_ENTP_IP, "get" + MedSrvDO.FG_USE_IP); // å¯ä½¿ç”¨æ ‡è¯†_ä½é™¢
			put(IBdFcDictCodeConst.SD_CODE_ENTP_FA, "get" + MedSrvDO.FG_USE_FM); // å¯ä½¿ç”¨æ ‡è¯†_å®¶åº­
			put(IBdFcDictCodeConst.SD_CODE_ENTP_ET_FLOW,"get" + MedSrvDO.FG_USE_ER);//å¯ä½¿ç”¨æ ‡è¯†_æ€¥è¯Šæµæ°´
			put(IBdFcDictCodeConst.SD_CODE_ENTP_ET_FSTAID,"get" + MedSrvDO.FG_USE_ER1);//å¯ä½¿ç”¨æ ‡è¯†_æ€¥è¯ŠæŠ¢æ•‘
			put(IBdFcDictCodeConst.SD_CODE_ENTP_ET_OBS,"get" + MedSrvDO.FG_USE_ER2);//å¯ä½¿ç”¨æ ‡è¯†_æ€¥è¯Šç•™è§‚
		}
		
	};

	// é—¨è¯Šä½é™¢çš„å¯ä½¿ç”¨çŠ¶æ€å¯¹åº”å…³ç³»ï¼Œç”¨äºå‡†ç¡®æç¤ºæœåŠ¡ä¸å¯ä½¿ç”¨çš„åœºæ™?
	// key å°±è¯Šç±»å‹ value å¯ä½¿ç”¨æ ‡è¯†å­—æ®µåç§?
	private final static Map<String, String> FG_USE_MSG = new HashMap<String, String>() {
		{
			put(IBdFcDictCodeConst.SD_CODE_ENTP_OP, "é—¨è¯Š"); // å¯ä½¿ç”¨æ ‡è¯†_é—¨è¯Š
			put(IBdFcDictCodeConst.SD_CODE_ENTP_PE, "ä½“æ£€"); // å¯ä½¿ç”¨æ ‡è¯†_ä½“æ£€
			put(IBdFcDictCodeConst.SD_CODE_ENTP_IP, "ä½é™¢"); // å¯ä½¿ç”¨æ ‡è¯†_ä½é™¢
			put(IBdFcDictCodeConst.SD_CODE_ENTP_FA, "å®¶åº­"); // å¯ä½¿ç”¨æ ‡è¯†_å®¶åº­
			put(IBdFcDictCodeConst.SD_CODE_ENTP_ET_FLOW,"æ€¥è¯Šæµæ°´");//å¯ä½¿ç”¨æ ‡è¯†_æ€¥è¯Šæµæ°´
			put(IBdFcDictCodeConst.SD_CODE_ENTP_ET_FSTAID,"æ€¥è¯ŠæŠ¢æ•‘");//å¯ä½¿ç”¨æ ‡è¯†_æ€¥è¯ŠæŠ¢æ•‘
			put(IBdFcDictCodeConst.SD_CODE_ENTP_ET_OBS,"æ€¥è¯Šç•™è§‚");//å¯ä½¿ç”¨æ ‡è¯†_æ€¥è¯Šç•™è§‚
		}
	};

	public CiOrTmplAggDTOMappingCiEmsDTO() throws BizException {
		ifreqdefMDORService = CiOrdAppUtils.getFreqdefMDORService();
		imedusageRService = (IMedusageRService) ServiceFinder.find(IMedusageRService.class);
		imedusagedesRService = (IMedusagedesRService) ServiceFinder.find(IMedusagedesRService.class);
		icherbboilmdMDORService = (ICherbboilmdMDORService) ServiceFinder.find(ICherbboilmdMDORService.class);
		icHerbBoilDesDORService = (ICHerbBoilDesDORService) ServiceFinder.find(ICHerbBoilDesDORService.class);
		imedsrvMDORService = (IMedsrvMDORService) ServiceFinder.find(IMedsrvMDORService.class);
		srvSetItemRSercie = (IMedSrvSetItemDORService) ServiceFinder.find(IMedSrvSetItemDORService.class);
		imedSrvRisDORService = (IMedSrvRisDORService) ServiceFinder.find(IMedSrvRisDORService.class);
		icidiagQryService = (ICidiagQryService) ServiceFinder.find(ICidiagQryService.class);
		drugManagementModel = BdMmParamUtils.GetDrugMCPropMM();
		calTimesCurBP = new CalTimesCurBP();
	}

	/**
	 * åŒ»å˜±æ¨¡æ¿æ˜ æˆCiEmsDTO
	 * 
	 * @param envinfo
	 *            ä¸Šä¸‹æ–‡ä¿¡æ?
	 * @param ciOrtmplAggDTO
	 *            åŒ»å˜±é€»è¾‘æ¨¡æ¿
	 * @return CiEmsDTO[]
	 * @throws BizException
	 */
	public MoreEmsParamDTO Mapping(CiEnContextDTO envinfo, CiOrTmplDTO[] ciOrtmplAggDTO) throws BizException {

		if (ciOrtmplAggDTO == null || ciOrtmplAggDTO.length == 0)
			return null;
		// ä¸å…è®¸é€šè¿‡åŠ©æ‰‹ç›´æ¥ä¿å­˜çš„åŒ»å˜±æç¤ºä¿¡æ?
		StringBuffer refusedMsg = new StringBuffer();

		// å¦‚æœæ˜¯åŒ»ä¿å°±è¯Šï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¿å¤–è¯Šæ–­
		if (FBoolean.TRUE.equals(envinfo.getFg_hpfundpay())) {

			// æŸ¥è¯¢ä¿å¤–è¯Šæ–­
			CiDiagItemDO[] ciDiagItems = icidiagQryService.getHpjudgetpCiDiagItems(envinfo.getId_en());
			CiEnContextUtil.SetHpCiDiagItem(envinfo, ciDiagItems);
		}

		mappingProperty = new InitMappingCiEmsProperty(envinfo);

		// æ„é€ å¥—å†…é¡¹ç›®é›†åˆkeyå€¼ä¸ºå¥—å†…é¡¹ç›®å¯¹åº”çš„æœåŠ¡id
		setItemSrvMap = new HashMap<String, MedSrvSetItemDO>();
		srvRisMap = new HashMap<String, MedSrvRisDO>();
		// æœåŠ¡å¥—ä¸å¥—å†…é¡¹ç›®å¯¹åº”å…³ç³»é›†åˆ
		srvSetItemsMap = new HashMap<String, List<MedSrvSetItemDO>>();

		this.createSrvSetItemMap(ciOrtmplAggDTO);

		// CiEmsDTO[] ciEmsDTOS = new CiEmsDTO[ciOrtmplAggDTO.length];
		List<CiEmsDTO> ciEmsList = new ArrayList<CiEmsDTO>();
		List<CiEmsDTO> errorEmsList = new ArrayList<CiEmsDTO>();
		// ä¼˜åŒ– ä¸€æ¬¡æŸ¥è¯?bd_srv
		bdSrvMap = OptimizationMedSrvDO(ciOrtmplAggDTO);
		for (int i = 0; i < ciOrtmplAggDTO.length; i++) {

			CiOrTmplDTO orTmplDTO = ciOrtmplAggDTO[i];
			String msg = this.getRefuseMsg(envinfo, orTmplDTO, bdSrvMap);
			if (StringUtils.isNotEmpty(msg)) {
				refusedMsg.append(msg).append(System.lineSeparator());
				continue;
			}
			//åˆ¤æ–­å•ä½æ˜¯å¦ä¸€è‡?
			String message = JudgeMMUintQuanTotalMed(envinfo,orTmplDTO);
			if (StringUtils.isNotEmpty(message)) {
				refusedMsg.append(message).append(System.lineSeparator());
				//continue;
			}
			// TODO: æ­¤å¤„åº”è¯¥æ ¹æ®ä¸åŒçš„åŒ»ç–—å•æœåŠ¡ï¼Œè°ƒç”¨ä¸åŒçš„æ˜ å°„æ–¹æ³•ï¼ˆæ™®è¯ã€è‰è¯ã€æ£€éªŒæ£€æŸ¥ã€æ‰‹æœ¯ã€ä¼šè¯Šã€æ²»ç–—ã€ç—…ç†ã€ç”¨è¡€ã€å¤‡è¡€ç­‰ç­‰ï¼?
			CiEmsDTO ciEmsDto = new CiEmsDTO();
			ciEmsDto.setStatus(DOStatus.NEW);// è®¾ç½®ä¸ºæ–°å»ºçŠ¶æ€?

			// æ ¹æ®ä¸Šä¸‹æ–‡ç¯å¢?+ åŒ»å˜±æ¨¡æ¿ç”Ÿæˆ = åŒ»ç–—å•CiEmsDTOæ•°æ®
			MappingFieldOrder(envinfo, ciEmsDto, orTmplDTO, bdSrvMap);
			// è¡¥å……å¯¹CiEms,CiEmsSrvçš„å±æ€§èµ‹å€?
			afterFieldMapping(envinfo, ciEmsDto);

			// åŒ»å˜±é¡¹ç›®

			
			ciEmsList.add(ciEmsDto);
			// ciEmsDTOS[i] = ciEmsDto;
		}

		// å°†CiEmsDTOé›†åˆè½¬æ¢ä¸?MoreEmsParamDTOå¯¹è±¡
		MoreEmsParamDTO moreEmsParam = new MoreEmsParamDTO();
		if (ciEmsList.size() > 0) {
			CovertTmplToMoreEmsParamBP bp = new CovertTmplToMoreEmsParamBP();
			moreEmsParam = bp.exec(envinfo, ciEmsList.toArray(new CiEmsDTO[0]));
		}
		if(!StringUtils.isEmpty(refusedMsg.toString())){
			String errroInfo = refusedMsg.toString();
			if(!StringUtils.isEmpty(moreEmsParam.getErrorinfo())){
				errroInfo += moreEmsParam.getErrorinfo();
			}
			moreEmsParam.setErrorinfo(errroInfo);
		}
		return moreEmsParam;
		// return ciEmsDTOS;
	}
	
	private String JudgeMMUintQuanTotalMed(CiEnContextDTO envinfo, CiOrTmplDTO ciOrTmplDTO) throws BizException {
		if (ciOrTmplDTO.getSd_srvtp().startsWith("01")) {
			// è·å–æœåŠ¡é¡¹ç›®
			FArrayList ciOrTmplSrvs = ciOrTmplDTO.getOrtmplsrvs();
			CiOrTmplSrvDTO tmplSrvDTO = (CiOrTmplSrvDTO) ciOrTmplSrvs.get(0); // å–ç¬¬0ä¸ªä½œä¸ºä¸»æœåŠ¡
		 	//è¯¥åŒ»å˜±ä¸‹ æ‰€æœ‰ç‰©å“å•ä½?
			MaterialUnitDTO[] materialUnitDTOs=BDMmDoseUnitInfoCache.getMaterialUnitInfos(envinfo.getCode_entp(),tmplSrvDTO.getId_mm().split(CiOrdUtils.COMMA_STR));
			if(CiOrdUtils.isEmpty(materialUnitDTOs)) {//æ²¡æœ‰è·å–åˆ°åŒ…è£…å•ä½?
				return null;
			}
			boolean flag=false;
			for(MaterialUnitDTO dto:materialUnitDTOs) {
				//åˆ¤æ–­è¯¥è¯å“çš„æ‰€æœ‰ç‰©å“å•ä½ä¸­æ˜¯å¦åŒ…å«æ¨¡æ¿çš„æ€»é‡å•ä½
				if (dto.getId_measdoc()!=null&&tmplSrvDTO.getId_unit_sale().equals(dto.getId_measdoc())) {
					flag = true;
				}
				
			}
			//è·å–é—¨è¯Šæ€»é‡ç¼–è¾‘æ¨¡å¼
			String paramString="";
			paramString = getDealWithUnitParam(paramString);
			if ("1".equals(paramString)) {//å¯ç¼–è¾?
				
				if (!flag) {
					return ciOrTmplDTO.getName()+"çš„è¯å“å•ä½å·²ä¿®æ”¹ï¼Œè¯·åœ¨åŒ»ç–—ä½†ä¸­ç»´æŠ¤æ€»é‡ æˆ–è€…å»ä½é™¢åŒ»å˜±æ¨¡æ¿èŠ‚ç‚¹ç»´æŠ¤è¯¥è¯å“çš„æ€»é‡";
				}
			}else{//ä¸å¯ç¼–è¾‘
				if (!flag) {//é‡æ–°è®¡ç®—æ€»é‡å€?
					tmplSrvDTO.setFactor_cur(materialUnitDTOs[0].getFactor());	
					tmplSrvDTO.setId_unit_sale(materialUnitDTOs[0].getId_measdoc());
					CalQuantumBP bp = new CalQuantumBP();
					String id_mm = tmplSrvDTO.getId_mm();
					MeterialAggDO mmagg = CiOrdAppUtils.getIMeterialRService().findById(id_mm);
					MeterialDO parentDO = mmagg.getParentDO();
					MMPackageUnitDO[] mmpackageUnits = mmagg.getMMPackageUnitDO();
					//è·å¾—å–æ•´æ¨¡å¼
					String sd_mupakgu=parentDO.getSd_opmutp();//å–æ•´æ¨¡å¼
					//åŒ»åŸºæ¢ç®—ç³»æ•°
					FDouble factor_mb = parentDO.getFactor_mb();
					//æ€»é‡å•ä½å¯¹åŸºæœ¬åŒ…è£…å•ä½çš„æ¢ç®—ç³»æ•°
					FDouble factor = bp.getFactorForUnitBaseToUnitSale(mmpackageUnits,tmplSrvDTO.getId_unit_sale());
					//åŒ»å˜±æ‰§è¡Œæ€»æ¬¡æ•
					GetTotalTimesBP bp1 = new GetTotalTimesBP();
					Integer times = 0;
					if (ciOrTmplDTO.getSd_srvtp().startsWith(IBdSrvDictCodeConst.SD_SRVTP_HERBDRUG)) {//è‰è¯å‰‚æ•°=æ¬¡æ•°
						times=ciOrTmplDTO.getOrders();
					}else{
						Date date = new Date();
					    SimpleDateFormat formatter = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
					    String dateString = formatter.format(date);
						times = bp1.getTotalTimes(new FDateTime(dateString),tmplSrvDTO.getId_freq(),ciOrTmplDTO.getDays_or());
					}
					FDouble quan_medu = tmplSrvDTO.getQuan_medu_cur();
					tmplSrvDTO.setQuan_total_medu(bp.getMMQuantum(sd_mupakgu, quan_medu, factor_mb, factor, times));
				}
				
			}
			
		}

			return null;
		
	}

	/**
	 * è·å–å¤„ç†å•ä½çš„å‚æ•?
	 * @param paramString
	 * @return
	 * @throws BizException
	 */
	private String getDealWithUnitParam(String paramString)throws BizException{
		try {
			paramString=ParamsetQryUtil.getParaString(Context.get().getOrgId(), "CIOR0210");//ã€é—¨è¯Šæ€»é‡ç¼–è¾‘æ§åˆ¶æ¨¡å¼ã€?
		} catch (Exception e) {
			paramString="0";//ä¸å¯ç¼–è¾‘
		}
		return paramString;
	}
	/**
	 * åˆ¤æ–­æ˜¯å¦æ”¯æŒæ¨¡æ¿ä¿å­˜<br/>
	 * 
	 * @param envinfo
	 *            å½“å‰å°±è¯Šä¸Šä¸‹æ–‡ç¯å¢?
	 * @param ciOrTmpl
	 *            æ ‡è¯†æ¨¡æ¿
	 * @param bdSrvMap
	 *            æœåŠ¡é›†åˆ
	 * @return
	 * @throws BizException
	 */
	private String getRefuseMsg(CiEnContextDTO envinfo, CiOrTmplDTO ciOrTmpl, Map<String, MedSrvDO> bdSrvMap)
			throws BizException {

		String codeEntp = envinfo.getCode_entp();

		if (FG_USE_MAP.containsKey(codeEntp)) {

			MedSrvDO medSrv = bdSrvMap.get(ciOrTmpl.getId_srv());
			if (!FBoolean.TRUE.equals(medSrv.getFg_active())) {
				return "æœåŠ¡ã€? + medSrv.getName() + "ã€‘å·²åœç”¨";
			}

			if ( !FBoolean.TRUE.equals(medSrv.getFg_or())) {
				return "æœåŠ¡ã€? + medSrv.getName() + "ã€‘ä¸ºéä¸´åºŠé¡¹ç›?;
			}
			if (medSrv.getSd_srvtp().startsWith(IBdSrvDictCodeConst.SD_SRVTP_BLOODPROD_A)) {
				return "æœåŠ¡ã€? + medSrv.getName() + "ã€‘ä¸æ”¯æŒé€šè¿‡åŠ©æ‰‹å¼€ç«‹åŒ»å˜?;
			}
			// try {

			// è·å–å¯ä½¿ç”¨æ ‡è¯†çš„getæ–¹æ³•å¹¶æ‰§è¡?
			/*
			 * Class<? extends MedSrvDO> cls = medSrv.getClass(); Method
			 * getMethod = cls.getDeclaredMethod(FG_USE_MAP.get(codeEntp));
			 */
			Object fgUse = "";// getMethod.invoke(medSrv);
			// medSrv.getFg_use_op()
			if (IBdFcDictCodeConst.SD_CODE_ENTP_OP.equals(codeEntp)) {
				fgUse = medSrv.getFg_use_op();
			} else if (IBdFcDictCodeConst.SD_CODE_ENTP_ET_FLOW.equals(codeEntp)) {
				fgUse = medSrv.getFg_use_er();
			}  else if (IBdFcDictCodeConst.SD_CODE_ENTP_ET_FSTAID.equals(codeEntp)) {
				fgUse = medSrv.getFg_use_er1();
			}  else if (IBdFcDictCodeConst.SD_CODE_ENTP_ET_OBS.equals(codeEntp)) {
				fgUse = medSrv.getFg_use_er2();
			} else if (IBdFcDictCodeConst.SD_CODE_ENTP_IP.equals(codeEntp)) {
				fgUse = medSrv.getFg_use_ip();
			} else if (IBdFcDictCodeConst.SD_CODE_ENTP_FA.equals(codeEntp)) {
				fgUse = medSrv.getFg_use_fm();
			} else if (IBdFcDictCodeConst.SD_CODE_ENTP_PE.equals(codeEntp)) {
				fgUse = medSrv.getFg_use_pe();
			}

			if (fgUse == null || !FBoolean.TRUE.equals(FBoolean.valueOf(fgUse.toString()))) {
				return FG_USE_MSG.get(codeEntp) + "ä¸­æœåŠ¡ã€? + medSrv.getName() + "ã€‘ä¸å¯ä½¿ç”?;
			}

			/*
			 * } catch (IllegalAccessException | InvocationTargetException |
			 * NoSuchMethodException e) {
			 * 
			 * throw new BizException("åŒ»å˜±æ¨¡æ¿æ˜ å°„è·å–è·å–å¯ä½¿ç”¨æ ‡è¯†å¤±è´?); }
			 */
		}
		return null;
	}

	/**
	 * è·å–bdå¥—å†…é¡¹ç›®é›†åˆ
	 * 
	 * @param ciEmsDTO
	 * @throws BizException
	 */

	private void createSrvSetItemMap(CiOrTmplDTO[] ciOrTmpls) throws BizException {
		StringBuffer idSrvBuffer = new StringBuffer();
		StringBuffer idSetSrvBuffer = new StringBuffer();
		for (CiOrTmplDTO ciOrTmpl : ciOrTmpls) {
			if (FBoolean.TRUE.equals(ciOrTmpl.getFg_set())) {
				idSrvBuffer.append(",'" + ciOrTmpl.getId_srv() + "'");
			}
		}

		if (idSrvBuffer.length() > 0) {
			// æŸ¥è¯¢å¥—å†…é¡¹ç›®
			String whereStr = "id_srv in (" + idSrvBuffer.substring(1) + ")";
			MedSrvSetItemDO[] medSrvSetItems = srvSetItemRSercie.find(whereStr, null, FBoolean.FALSE);
			for (MedSrvSetItemDO medSrvSetItem : medSrvSetItems) {
				
				// æ„é€ å¥—å†…é¡¹ç›®å¯¹åº”æœåŠ¡idï¼Œç”¨äºå…¶ä»–å±æ€§æŸ¥è¯?
				idSetSrvBuffer.append(",'" + medSrvSetItem.getId_srv_itm() + "'");
				// å¥—å†…é¡¹ç›®å¯¹åº”çš„æœåŠ¡mapé›†åˆ
				setItemSrvMap.put(medSrvSetItem.getId_srv_itm(), medSrvSetItem);
				// æ„é€ å¥—å†…é¡¹ç›®é›†åˆmapç»“æ„
				List<MedSrvSetItemDO> setItemList = null;
				if (srvSetItemsMap.containsKey(medSrvSetItem.getId_srv())) {
					setItemList = srvSetItemsMap.get(medSrvSetItem.getId_srv());
				} else {
					setItemList = new ArrayList<MedSrvSetItemDO>();
					srvSetItemsMap.put(medSrvSetItem.getId_srv(), setItemList);
				}
				setItemList.add(medSrvSetItem);
					
			}

			if(idSetSrvBuffer!=null &&idSetSrvBuffer.length()>0) {
				// æŸ¥è¯¢æ£€æŸ¥å±æ€?
				String whereStrRis = "id_srv in (" + idSetSrvBuffer.substring(1) + ")";
				MedSrvRisDO[] medSrvRises = imedSrvRisDORService.find(whereStrRis, null, FBoolean.FALSE);
				for (MedSrvRisDO medSrvRis : medSrvRises) {
					srvRisMap.put(medSrvRis.getId_srv(), medSrvRis);
				}
			}
		}
	}

	/**
	 * åŒ»å˜±æ¨¡æ¿çš„æ˜ å°?æ™®é€šè¯å“åŒ»ç–—å•)
	 * 
	 * @param envinfo
	 * @param ciEmsDto
	 * @param aggDto
	 * @throws BizException
	 */
	private void MappingFieldOrder(CiEnContextDTO envinfo, CiEmsDTO ciEmsDto, CiOrTmplDTO ciOrTmplDTO,
			Map<String, MedSrvDO> bdSrvMap) throws BizException {

		// å¯¹åº”çš?bd_srvï¼Œä¼ é€’æ•°æ®ä¸ºåŒ»å˜±æ¨¡æ¿æ—?
		ciEmsDto.setId_srv(ciOrTmplDTO.getId_srv());
		// ä¼˜åŒ– ä¸€æ¬¡æŸ¥è¯?
		// MedSrvDO medSrvDO =
		// imedsrvMDORService.findById(ciEmsDto.getId_srv());
		MedSrvDO medSrvDO = null;
		if (bdSrvMap != null) {
			medSrvDO = bdSrvMap.get(ciEmsDto.getId_srv());
		}
		if (medSrvDO == null) {
			OrdBizLogger.info(envinfo, "æ ‡å‡†æ¨¡æ¿è½¬CiEmsDTOæ—¶æ ¹æ®id_srv[" + ciEmsDto.getId_srv() + "]æœªè·å–åˆ°æœåŠ¡é¡¹ç›®");
			throw new BizException("æ ‡å‡†æ¨¡æ¿è½¬CiEmsDTOæ—¶æ ¹æ®id_srv[" + ciEmsDto.getId_srv() + "]æœªè·å–åˆ°æœåŠ¡é¡¹ç›®");
		}

		ValidateDataDTO param = new ValidateDataDTO();
		param.setMedSrv(medSrvDO);
		List<String> msgList = AssembleAssiChain.startValidate(envinfo, param);
		if (msgList.size() > 0) {
			throw new BizException(MessageConvertUtil.convertListToString(msgList));
		}
		// ciEmsDto.setNote(ciOrTmplDTO.getDes_or());//åŒ»å˜±æè¿°
		ciEmsDto.setId_pat(envinfo.getId_pat());// æ‚£è€?
		ciEmsDto.setId_en(envinfo.getId_en());// å°±è¯Š
		ciEmsDto.setId_entp(envinfo.getId_entp());// å°±è¯Šç±»å‹
		ciEmsDto.setCode_entp(envinfo.getCode_entp());// å°±è¯Šç±»å‹ç¼–ç 
		ciEmsDto.setId_srvtp(medSrvDO.getId_srvtp());// åŒ»å˜±ç±»å‹
		ciEmsDto.setSd_srvtp(medSrvDO.getSd_srvtp());// åŒ»å˜±ç±»å‹ç¼–ç 
		ciEmsDto.setId_wg_or(envinfo.getId_wg_or());
		ciEmsDto.setId_freq(ciOrTmplDTO.getId_freq());// é¢‘æ¬¡id
		ciEmsDto.setId_excessive_reason(ciOrTmplDTO.getId_excessive_reason());
		ciEmsDto.setSd_excessive_reason(ciOrTmplDTO.getSd_excessive_reason());
		// å¥—æœåŠ¡æ˜¯å¦åŒ…å«å¥—å†…é¡¹ç›®ï¼Œç»„å¥—ä¸­çš„å¥—éƒ½ä¸åŒ…å«å¥—å†…é¡¹ç›?
		CiOrTmplSrvDTO tmplSrvDTO = null;
		if (OrSourceFromEnum.IIHCLINICALKITHELPER != ciOrTmplDTO.getEu_orsrcmdtp()) {// ä¸æ˜¯æ¥æºç»„å¥—
			// è·å–æœåŠ¡é¡¹ç›®
			FArrayList ciOrTmplSrvs = ciOrTmplDTO.getOrtmplsrvs();
			tmplSrvDTO = (CiOrTmplSrvDTO) ciOrTmplSrvs.get(0); // å–ç¬¬0ä¸ªä½œä¸ºä¸»æœåŠ¡
			// å°†æ¨¡æ¿ä¸­çš„ç”¨æ³•ã€ç…æ³?èµ‹å€¼åˆ°CiEmsDTOä¸?
			ciEmsDto.setId_route(tmplSrvDTO.getId_route());// ç”¨æ³•id
			ciEmsDto.setId_routedes(tmplSrvDTO.getId_routedes());// ç”¨æ³•è¦æ±‚
			ciEmsDto.setId_boil(tmplSrvDTO.getId_boil());// è®¾ç½®ç…æ³•id
			ciEmsDto.setId_boildes(tmplSrvDTO.getId_boildes());// ç…æ³•è¦æ±‚id
			ciEmsDto.setId_dep_mp(tmplSrvDTO.getId_dep_mp());

		}
		if (envinfo != null && (IBdFcDictCodeConst.SD_CODE_ENTP_IP).equals(envinfo.getCode_entp())) {
			ciEmsDto.setDays_or(null);// åŒ»å˜±å¤©æ•°
		} else {
			ciEmsDto.setDays_or(ciOrTmplDTO.getDays_or());// åŒ»å˜±å¤©æ•°
		}
		
		// 0161344: æ€¥è¯Šç§‘å¼€çš„æ£€éªŒé¡¹ç›®ï¼Œé»˜è®¤å‹¾ä¸ŠåŠ æ€¥æ ‡å¿?å‚æ•° XH_CIOR0001
		// æ€¥è¯Šç§‘å®¤åˆ¤æ–­æ–¹å¼ 1ã€å½“å‚æ•°ã€æ˜¯å¦æ€¥è¯Šå°±è¯Šåˆ¤æ–­æ–¹å¼ã€? 1 and å½“å‰ç™»å½•ç§‘å®¤ in ã€æ˜¯å¦æ€¥è¯Šå°±è¯Šç§‘å®¤ã€‘å‚æ•°å€?and
		// ã€æ€¥è¯Šç§‘å¼€çš„æ£€éªŒé¡¹ç›®ï¼Œé»˜è®¤å‹¾ä¸ŠåŠ æ€¥æ ‡å¿—ã€?= TRUE æ—¶ï¼Œé—¨è¯ŠåŒ»ç”Ÿç«™å¼€æ£€éªŒåŒ»å˜±ï¼Œé»˜è®¤å‹¾é€‰åŠ æ€¥æ ‡å¿—ã€?
		try {
			// ã€æ˜¯å¦æ€¥è¯Šå°±è¯Šåˆ¤æ–­æ–¹å¼ã€?
			Integer judge_urgent = ParamUtils.getOrgParamIntegerValue(ICiOrdCustomSysParamConst.LL_JUDGE_URGENT);
			// ã€æ˜¯å¦æ€¥è¯Šå°±è¯Šç§‘å®¤ã€?
			String is_urgent = ParamUtils.getOrgParamStringValue(ICiOrdCustomSysParamConst.LL_IS_URGENT);
			// ã€æ€¥è¯Šç§‘å¼€çš„æ£€éªŒé¡¹ç›®ï¼Œé»˜è®¤å‹¾ä¸ŠåŠ æ€¥æ ‡å¿—ã€?
			FBoolean lis_fg_urgent = ParamUtils.getOrgParamFBooleanValue(ICiOrdCustomSysParamConst.XH_LIS_FG_URGENT);
			// å½“å‰ç§‘å®¤æ˜¯å¦æ€¥è¯Šç§‘å®¤
			FBoolean isUrgentDep = FBoolean.FALSE;
			if (FBoolean.TRUE.equals(lis_fg_urgent) && judge_urgent == 1
					&& is_urgent.contains(envinfo.getId_dep_or())) {
				isUrgentDep = FBoolean.TRUE;
			}
			if (FBoolean.TRUE.equals(lis_fg_urgent) && FBoolean.TRUE.equals(isUrgentDep) && ciEmsDto.getSd_srvtp().startsWith(IBdSrvDictCodeConst.SD_SRVTP_LIS)) {
				ciEmsDto.setFg_urgent(FBoolean.TRUE);
			} else {
				ciEmsDto.setFg_urgent(FBoolean.FALSE);
			}

		} catch (Exception e) {
			ciEmsDto.setFg_urgent(FBoolean.FALSE);
		}
		
		// æ…¢ç—…æ ‡è¯†
		if (ICiDoctorStationTypeConst.Type_Op_MbDoctor_Station.equals(envinfo.getStationType())) {
			ciEmsDto.setId_excessive_reason(ICiDictCodeConst.ID_EXCESSIVE_REASON_CHRONIC);
			ciEmsDto.setSd_excessive_reason(ICiDictCodeConst.SD_EXCESSIVE_REASON_CHRONIC);
		}
		FMap2 m1=envinfo.getEmsopenparam();
		if(m1!=null&&m1.containsKey("Id_excessive_reason")&&m1.containsKey("Sd_excessive_reason")) {
			String Id_excessive_reason=(String)m1.get("Id_excessive_reason");
			String Sd_excessive_reason=(String)m1.get("Sd_excessive_reason");
			String Name_excessive_reason=(String)m1.get("Name_excessive_reason");
			if(Id_excessive_reason!=null&&Sd_excessive_reason!=null) {
				ciEmsDto.setId_excessive_reason(Id_excessive_reason);
				ciEmsDto.setSd_excessive_reason(Sd_excessive_reason);
				ciEmsDto.setName_excessive_reason(Name_excessive_reason);
			}
			
		}
		// è¡¥å…¨é¢‘æ¬¡ã€é¢‘æ¬¡ä¸‹æ¬¡æ•°ã€ç”¨æ³•ã€ç”¨æ³•è¦æ±‚ã€ç…æ³•ã€ç…æ³•è¦æ±?
		this.setCiEmsDTOUseDetailByMedSrv(envinfo, ciEmsDto, medSrvDO);

		// æ‰§è¡Œç§‘å®¤ æ‰§è¡Œå®Œæ˜ å°„åœ¨è®¾ç½®æ‰§è¡Œç§‘å®¤
		// OrWfDeptInfoDTO deptMpDto = this.getMpDeptID(envinfo, medSrvDO,null);

		// ciEmsDto.setSd_orrsttp(ciOrTmplDTO.getSd_orrsttp());//åŒ»å˜±ç»“æœç¼–ç 
		// ciEmsDto.setId_dep_mp(deptMpDto.getFirstid_mp_dept());// æ‰§è¡Œç§‘å®¤Id
		// ciEmsDto.setName_dep_mp(deptMpDto.getFirstname_mp_dept());// æ‰§è¡Œç§‘å®¤åç§°
		// bug 0112780: [å›½é™…ç°åœº]åŒ»å˜±æ¨¡æ¿å¼€ç«‹x-rayæ•°å­—åŒ–ç‰™ç‰‡å‰‚é‡ä¸ºç©?
		if (!medSrvDO.getFg_mm().booleanValue()) {
			ciEmsDto.setId_unit_med(medSrvDO.getId_unit_med());// åŒ»å­¦å•ä½
			ciEmsDto.setName_unit_med(medSrvDO.getMed_name());// åŒ»å­¦å•ä½åç§°
		}

		ciEmsDto.setId_srvca(medSrvDO.getId_srvca());// åŒ»å˜±åŸºæœ¬åˆ†ç±»
		ciEmsDto.setInnercode_srvca(medSrvDO.getSrvca_innercode());// æœåŠ¡åˆ†ç±»å†…ç 
		ciEmsDto.setId_grp(envinfo.getId_grp());// æ‰€å±é›†å›?
		ciEmsDto.setId_org(envinfo.getId_org());// æ‰€å±ç»„ç»?
		ciEmsDto.setEmsappmode(envinfo.getEmsappmode());// åŒ»ç–—å•åº”ç”¨åœºæ™?
		// æ€»é‡å¼€å•æ–¹å¼ï¼Œå¤šé¢‘æ¬¡ï¼Œå¤šå‰‚é‡?
		ciEmsDto.setSd_totalopenmode(medSrvDO.getSd_totalopenmode());
		ciEmsDto.setIsmulexec(medSrvDO.getIsmulexec());
		ciEmsDto.setIsmuldose(medSrvDO.getIsmuldose());

		// ciEmsDto.setName_ems(medSrvDO.getName());// åŒ»ç–—å•æ˜¾ç¤ºåç§?
		// åŒ»ç–—å•åç§°ä¸æ˜¯æœåŠ¡åï¼Œä»EmsMatchRstDTOä¸­å–

		// ciEmsDto.setId_orpltp(ciOrTmplDTO.getId_orpltp());//åŒ»å˜±æ‰§è¡Œé—­ç¯ç±»å‹

		// ciEmsDto.setMapkeys(ciOrTmplDTO.getMapkeys());//é™„åŠ ä¿¡æ¯Mapé”®å€¼ä¸²
		// ciEmsDto.setMapinfo(ciOrTmplDTO.getMapinfo());//ç›¸å…³é™„åŠ ä¿¡æ¯MAP
		// ciEmsDto.setFg_syncfee(ciOrTmplDTO.getFg_syncfee());//è´¹ç”¨åŒæ­¥æ ‡è¯†
		// ciEmsDto.setFreqct(ciOrTmplDTO.getFreqct());//é¢‘æ¬¡ä¸‹æ¬¡æ•?
		// ciEmsDto.setFrequnitct(ciOrTmplDTO.getFrequnitct());//é¢‘æ¬¡å‘¨æœŸæ•?
		// ciEmsDto.setSd_frequnitct(ciOrTmplDTO.getSd_frequnitct());//é¢‘æ¬¡å‘¨æœŸç±»å‹ç¼–ç 
		// ciEmsDto.setSrvsetitms(ciOrTmplDTO.getSrvsetitms());//å¥—å¯¹åº”çš„å¥—å†…é¡¹ç›®é›†åˆ

		// ciEmsDto.setOrapplysheet(ciOrTmplDTO.getOrapplysheet());//åŒ»å˜±å¯¹åº”çš„ç”³è¯·å•

		ciEmsDto.setId_dept_en(envinfo.getId_dep_en());// å°±è¯Šç§‘å®¤
		ciEmsDto.setId_dept_ns(envinfo.getId_dep_ns());// æŠ¤ç†å•å…ƒ
		ciEmsDto.setFg_set(medSrvDO.getFg_set());// æ˜¯å¦æ˜¯å¥—
		ciEmsDto.setDes_or(ciOrTmplDTO.getDes_or());// å˜±æ‰˜

		// ciEmsDto.setCiorfreqtimes(ciOrTmplDTO.getCiorfreqtimes());//åŒ»å˜±è®¡åˆ’é¢‘æ¬¡æ‰§è¡Œæ—¶åˆ»é›†åˆ
		ciEmsDto.setFg_pres_outp(FBoolean.FALSE);// å‡ºé™¢å¸¦è¯æ ‡è¯†

		// é—¨è¯Šä¸ä½¿ç”¨åå°åŒ¹é…åŒ»ç–—å•
		SrvMatchEmsRstDTO emsmatch = getFuncClassStr(envinfo, medSrvDO);
		if (emsmatch == null) {
			ciEmsDto.setEmstype(EmsType.COMMON);
			ciEmsDto.setFg_quickwflow(FBoolean.FALSE);
			// throw new BizException("åŒ»ç–—æœåŠ¡ ï¼? + medSrvDO.getName() + " é…ä¸åˆ°åŒ»ç–—å•
			// ");
		} else {
			ciEmsDto.setFuncclassstr(emsmatch.getFuncclassstr());// åŒ»ç–—å•URL
			ciEmsDto.setId_srvof(emsmatch.getId_ems());// åŒ»ç–—å?
			ciEmsDto.setName_ems(emsmatch.getName_show());// åŒ»ç–—å•åç§?
			ciEmsDto.setFg_quickwflow(emsmatch.getFg_quickwflow());
			// emsTypeå·²ç»åºŸå¼ƒä¸ç”¨äº?
			// try {
			// ciEmsDto.setEmstype(Integer.parseInt(CiOrdUtils.getEmsFunclassKVDTO(emsmatch.getFuncclassstr()).getEmstype()));//åŒ»ç–—å•ç±»å?
			// } catch (Exception ex) {
			// OrdBizLogger.info(envinfo,"åŒ»ç–—æœåŠ¡ ï¼? + medSrvDO.getName() + "
			// æ‰¾ä¸åˆ°åŒ»ç–—å•ç±»å‹ ");
			// throw new BizException("åŒ»ç–—æœåŠ¡ ï¼? + medSrvDO.getName() + " æ‰¾ä¸åˆ°åŒ»ç–—å•ç±»å‹
			// ");
			// }
		}
		if (!"0902".equals(medSrvDO.getSd_srvtp())) {
		ciEmsDto.setApplyno(CiOrdUtils.getApplyNo(medSrvDO.getSd_srvtp()));// ç”³è¯·å•å·
		}
		// ciEmsDto.setFg_urgent(ciOrTmplDTO.getFg_urgent());//åŠ æ€¥æ ‡è¯?

		// ciEmsDto.setId_orrsttp(ciOrTmplDTO.getId_orrsttp());//åŒ»å˜±ç»“æœ
		// ciEmsDto.setId_or(ciOrTmplDTO.getId_or());//åŒ»å˜±ä¸»é”®æ ‡è¯†

		// ciEmsDto.setId_srv_pkg(ciOrTmplDTO.getId_srv_pkg());//æœåŠ¡åŒ?
		if (!envinfo.getCode_entp().equals(IBdFcDictCodeConst.SD_CODE_ENTP_IP)) { // ä½é™¢çš„å¸¸ä¸´æ ‡è¯†é€šè¿‡
																					// setCiEmsDTOUseDetailByMedSrv
																					// ä¸­é¢‘æ¬¡å®šä¹‰è®¾ç½®ï¼Œé—¨è¯Šçš„éƒ½è®¾ç½®false
			if (ciEmsDto.getFg_long() == null) {
				ciEmsDto.setFg_long(FBoolean.FALSE);// é•¿ä¸´æ ‡è¯†
			}

		}

		// ciEmsDto.setEmstype(JudgeEmsType(medSrvDO.getSd_srvtp()));//
		// åŒ»ç–—å•ç±»å?è¯å“)
		ciEmsDto.setFg_boil(ciOrTmplDTO.getFg_boil());// ä»£ç…æ ‡è¯†

		ciEmsDto.setOrders(ciOrTmplDTO.getOrders());// åŒ»å˜±ä»˜æ•°
		ciEmsDto.setOrders_boil(ciOrTmplDTO.getOrders());// ä»£ç…ä»˜æ•°
		ciEmsDto.setCode(ciOrTmplDTO.getCode());// ç¼–ç 
		if (StringUtils.isBlank(ciEmsDto.getCode())) {
			ciEmsDto.setCode(medSrvDO.getCode());// ç¼–ç 
		}
		ciEmsDto.setName(ciOrTmplDTO.getName());// åŒ»å˜±åç§°
		if (StringUtils.isBlank(ciEmsDto.getName())) {
			ciEmsDto.setName(medSrvDO.getName());
		}
		// ciEmsDto.setNote(ciOrTmplDTO.getNote());//å¤‡æ³¨
		ciEmsDto.setId_emp_phy(envinfo.getId_emp_or());// å¼€ç«‹åŒ»ç”?
		// ciEmsDto.setName_emp_phy(envinfo.getName_emp());//å¼€ç«‹åŒ»ç”Ÿå§“å?
		ciEmsDto.setId_dep_phy(envinfo.getId_dep_or());// å¼€ç«‹ç§‘å®?
		// ciEmsDto.setName_dep_phy(ciOrTmplDTO.getName_dep_phy());//å¼€ç«‹ç§‘å®¤åç§?
		ciEmsDto.setId_wg_or(envinfo.getId_wg_or());// åŒ»ç–—ç»?
		if (FBoolean.TRUE.equals(medSrvDO.getFg_mm())&&!StringUtils.isEmpty(ciEmsDto.getId_freq())) {
			FDateTime tm = CalDtEffeBP.GetDtEffe(ciEmsDto.getId_freq());
			ciEmsDto.setDt_begin(tm); // SINGLE
		}else{
			ciEmsDto.setDt_begin(CiOrdAppUtils.getServerDateTime());// å¼€å§‹æ—¥æœ?é—¨è¯Šæ¨¡æ¿ä¸ç”¨æ ¼å¼åŒ–æ—¶é—?
		}
		if (!CiOrdUtils.isEmpty(ciEmsDto.getDays_or())) {
			ciEmsDto.setDt_end(new FDateTime(ciEmsDto.getDt_begin().getBeginDate().getDateAfter(ciEmsDto.getDays_or()),
					ciEmsDto.getDt_begin().getUFTime()));// ç»“æŸæ—¥æœŸ
		}
		// ciEmsDto.setDt_end(ciOrTmplDTO.getDt_end());//ç»“æŸæ—¥æœŸ
		// ciEmsDto.setContent(ciOrTmplDTO.getContent());//åŒ»å˜±å†…å®¹
		// ciEmsDto.setDt_invalid(ciOrTmplDTO.getDt_invalid());//åŒ»å˜±è¿‡æœŸæ—¶é—´
		ciEmsDto.setFg_bb(envinfo.getFg_bb());// å©´å„¿æ ‡è¯†
		ciEmsDto.setNo_bb(envinfo.getNo_bb());// å©´å„¿åºå·

		// ciEmsDto.setFg_pmor(ciOrTmplDTO.getFg_pmor());//å¤‡ç”¨åŒ»å˜±æ ‡è¯†
		// ciEmsDto.setDes_pmor(ciOrTmplDTO.getDes_pmor());//å¤‡ç”¨åŒ»å˜±ä½¿ç”¨æ¡ä»¶æè¿°
		// ciEmsDto.setId_or_rel(ciOrTmplDTO.getId_or_rel());//å…³è”åŒ»å˜±
		// ciEmsDto.setFg_ctlcp(ciOrTmplDTO.getFg_ctlcp());//ä¸´åºŠè·¯å¾„æ§åˆ¶æ ‡è¯†
		// ciEmsDto.setFg_mr(ciOrTmplDTO.getFg_mr());//åŒ»ç–—è®°å½•è”åŠ¨æ ‡è¯†
		// ciEmsDto.setFg_skintest(ciOrTmplDTO.getFg_skintest());//éœ€çš®è¯•æ ‡è¯†
		// ciEmsDto.setId_skintest_skip_reaso(ciOrTmplDTO.getId_skintest_skip_reaso());//ä¸çš®è¯•åŸå› ï¼ˆåºŸå¼ƒä¸ç”¨äº†ï¼‰
		// ciEmsDto.setSd_skintest_skip_reaso(ciOrTmplDTO.getSd_skintest_skip_reaso());//ä¸çš®è¯•åŸå› ç¼–ç ï¼ˆåºŸå¼ƒä¸ç”¨äº†ï¼‰
		if (FBoolean.TRUE.equals(ciEmsDto.getIsmulexec())) {
			if (ciEmsDto.getSd_totalopenmode()!=null && "0".equals(ciEmsDto.getSd_totalopenmode())) {//å‘¨æœŸå¼€ç«?
				//è®¡ç®—æ€»æ¬¡æ•?
				GetTotalTimesBP  bp = new GetTotalTimesBP();
				Integer totalTimes = bp.getTotalTimes(ciOrTmplDTO.getDt_effe(), ciEmsDto.getId_freq(), ciEmsDto.getDays_or());
				ciEmsDto.setTimes_cur(totalTimes);
			}else{
				ciEmsDto.setTimes_cur(ciOrTmplDTO.getTimes());
			}
		}
		
		if (CiOrdUtils.isEmpty(ciEmsDto.getTimes_cur())) {
			ciEmsDto.setTimes_cur(calTimesCurBP.exec(ciEmsDto));// æ€»æ¬¡æ•?
		}
		
		ciEmsDto.setFg_mp_in(mappingProperty.getFgMpIn(ciEmsDto.getCode_entp(),ciEmsDto.getSd_srvtp(),ciEmsDto.getId_route())); // åœ¨é™¢æ‰§è¡ŒçŠ¶æ€?
		CiEmsDefaultValueSetBP defaultSetbp = new CiEmsDefaultValueSetBP();
		defaultSetbp.exec(ciEmsDto);// è®¾ç½®åœ¨é™¢æ‰§è¡ŒçŠ¶æ€?
		// ciEmsDto.setFg_mp_in(FBoolean.TRUE);// åœ¨é™¢æ‰§è¡Œæ ‡è¯†
		// ä»åŠ©æ‰‹ç”Ÿæˆçš„åŒ»ç–—å•éƒ½è®¾ç½®åœ¨é™¢æ‰§è¡Œï¼Œï¼ˆåŒ»ç–—å•ä¸­å¯ä»¥æ ¹æ®åŒ»ç”Ÿæ‚£è€…æ²Ÿé€šç¡®å®šæ˜¯å¦éœ€è¦åœ¨é™¢æ‰§è¡Œï¼‰

		if (ciEmsDto.getFg_mp_in().booleanValue()) { // åœ¨é™¢æ‰§è¡Œæ—?
			ciEmsDto.setTimes_mp_in(ciEmsDto.getTimes_cur());// å¦‚æœæ˜¯åœ¨é™¢æ‰§è¡Œï¼ŒåŠ©æ‰‹ä¸­çš„æ„é€ çš„åŒ»å˜±ç­‰äºæ€»æ¬¡æ•?
			/*
			 * if (ciEmsDto.getTimes_mp_in() != null) { // TODO
			 * ä¸Šè¾¹æ²¡æœ‰è®¾ç½®åœ¨é™¢æ‰§è¡Œæ¬¡æ•°çš„åœ°æ–¹ï¼Œè¿™ä¸ªåˆ¤æ–­æ²¡æ„ä¹?
			 * ciEmsDto.setTimes_mp_in(ciEmsDto.getTimes_mp_in()); } else {
			 * ciEmsDto.setTimes_mp_in(CiOrdUtils.JudgeTiemMpIn(ciEmsDto));
			 * ciEmsDto.setTimes_cur(ciEmsDto.getTimes_mp_in());// æ€»æ¬¡æ•?TODO
			 * æ€»æ¬¡æ•°é€»è¾‘ }
			 */
		}


		// ciEmsDto.setFg_mp_bed(ciOrTmplDTO.getFg_mp_bed());//åºŠè¾¹æ‰§è¡Œæ ‡è¯†
		// ciEmsDto.setTimes_firday_mp(ciOrTmplDTO.getTimes_firday_mp());//é¦–æ—¥æ‰§è¡Œæ¬¡æ•°
		// ciEmsDto.setFg_or_doc(ciOrTmplDTO.getFg_or_doc());//åŒ»ç”ŸåŒ»å˜±æ ‡è¯†
		// ciEmsDto.setId_su_or(ciOrTmplDTO.getId_su_or());//åŒ»å˜±çŠ¶æ€?
		// ciEmsDto.setSd_su_or(ciOrTmplDTO.getSd_su_or());//åŒ»å˜±çŠ¶æ€ç¼–ç ?
		// ciEmsDto.setFg_active_pm(ciOrTmplDTO.getFg_active_pm());//å¤‡ç”¨åŒ»å˜±å¯ç”¨æ ‡è¯†
		// ciEmsDto.setId_reltp(ciOrTmplDTO.getId_reltp());//å…³è”åŒ»å˜±ç±»å‹ç¼–ç 
		// ciEmsDto.setSd_reltp(ciOrTmplDTO.getSd_reltp());//å…³è”åŒ»å˜±ç±»å‹
		ciEmsDto.setEu_orsrcmdtp(ciOrTmplDTO.getEu_orsrcmdtp()); // æ•°æ®æ¥æºç±»å‹
																	// OrSourceFromEnum
																	// æ—¢å¾€ã€ç»„å¥—ã€æ¨¡æ¿ã€å¸¸è§„ã€åˆ†ç±?..
		ciEmsDto.setId_orsrc_main(ciOrTmplDTO.getId_orsrc_main());// æ•°æ®æ¥æºid
																	// ï¼Œæ—¢å¾€id_or
																	// ,ç»„å¥—çš„å®šä¹‰idï¼Œæ¨¡æ?å¸¸è§„)idï¼?
																	// åˆ†ç±»id
		ciEmsDto.setId_orsrc_sub(ciOrTmplDTO.getId_orsrc_sub()); // æ¨¡æ¿ï¼ˆå¸¸è§„ï¼‰æ˜ç»†id
		ciEmsDto.setId_orsrc_subsub(ciOrTmplDTO.getId_orsrc_subsub());// åŒ»å˜±æ¥æºå­™æ ‡è¯?
		// å­˜åœ¨ä¿å¤–è¯Šæ–­æ—¶ï¼ŒåŒ»ä¿å°±è¯ŠçŠ¶æ€è°ƒæ•´ä¸ºä¸éœ€è¦åˆ¤æ–­åŒ»ä¿çŠ¶æ€ï¼ˆéåŒ»ä¿çŠ¶æ€ï¼‰
		if (HpBeyondEnum.HPEXTERNALDIAG.equals(envinfo.getEu_hpbeyond())) {
			ciEmsDto.setEu_hpindicjudge(HpIndicJudgeEnum.NONEEDJUDGE);
		}

		ciEmsDto.setBhpjudgerst(envinfo.getBhpjudgerst()); // åŸºæœ¬åŒ»ä¿åˆ¤æ–­ç»“æœæ•°æ®ä¿¡æ¯
		ciEmsDto.setDes_bhpjudgerst(envinfo.getDes_bhpjudgerst()); // åŸºæœ¬åŒ»ä¿åˆ¤æ–­ç»“æœæ•°æ®ä¿¡æ¯æè¿°
		// è¯Šæ–­èµ‹å€?
		DiagOutlineInfo diagOutlineInfo = DiagInfoUtils.GetDiagOutLineInfo(envinfo.getId_en());
		if (diagOutlineInfo != null) {
			ciEmsDto.setId_didef(diagOutlineInfo.getId_didef());// ä¸»è¯Šæ–­çš„ä¸»é¡¹ç›®id
			ciEmsDto.setName_didef(diagOutlineInfo.getName_diag());// ä¸»è¯Šæ–­åç§?
			ciEmsDto.setId_diitm(diagOutlineInfo.getId_diitm());//è¯Šæ–­
			FMap2 m=envinfo.getEmsopenparam();
			if(m!=null&&m.containsKey("Id_di")&&m.containsKey("Id_diitem")) {
				String id_di=(String)m.get("Id_di");
				String id_diitm=(String)m.get("Id_diitem");
				if(id_di!=null&&id_diitm!=null) {
					if(diagOutlineInfo.getId_di().equals(id_di.trim())) {
						ICiDiagItemDORService itmser=ServiceFinder.find(ICiDiagItemDORService.class);
						CiDiagItemDO itm=itmser.findById(id_diitm.trim());
						if(itm!=null) {
							if(itm.getId_didef()!=null) {
								ciEmsDto.setId_diitm(itm.getId_diitm());
								ciEmsDto.setId_didef(itm.getId_didef());// ä¸»è¯Šæ–­çš„ä¸»é¡¹ç›®id
								ciEmsDto.setName_didef(itm.getId_didef_name());// ä¸»è¯Šæ–­åç§?
							}
						}
					}
				}
				
			}
			
		}
		if (OrSourceFromEnum.IIHCLINICALKITHELPER == ciOrTmplDTO.getEu_orsrcmdtp()
				&&FBoolean.TRUE.equals( ciOrTmplDTO.getFg_set())) {// æ¥æºç»„å¥—
			this.setMkrSetProperty(ciEmsDto, envinfo, ciOrTmplDTO, medSrvDO);
		} else {
			// åˆ›å»ºå¥—å†…é¡¹ç›®é›†åˆ
			ciEmsDto.setSrvsetitms(this.createCiEmsSrvSetItems(ciOrTmplDTO));

			// åŒ»å˜±é¡¹ç›®
			FArrayList list = this.getEmssrvs(ciEmsDto,envinfo, ciOrTmplDTO, medSrvDO);
			ciEmsDto.setEmssrvs(list);// åŒ»ç–—å•é¡¹ç›®é›†å?

			// ciEmsDto ä¿ç•™å‰‚é‡
			CiEmsSrvDTO ciEmsSrv = (CiEmsSrvDTO) list.get(0);
			FArrayList srvlist = ciOrTmplDTO.getOrtmplsrvs();
			if (srvlist != null) {
				CiOrTmplSrvDTO tmplSrv = (CiOrTmplSrvDTO) srvlist.get(0);
				ciEmsDto.setQuan_medu(tmplSrv.getQuan_med());
			} else {
				ciEmsDto.setQuan_medu(ciEmsSrv.getQuan_med());
			}

		}

		// è®¾ç½®æœåŠ¡ä»·æ ¼
		this.setCiEmsPrice(envinfo, ciEmsDto, medSrvDO);

		FArrayList emssrvList = ciEmsDto.getEmssrvs();
		for (Object obj : emssrvList) {
			CiEmsSrvDTO srvDTO = (CiEmsSrvDTO) obj;
			if (FBoolean.TRUE.equals(srvDTO.getFg_skintest())) {
				ciEmsDto.setFg_skintest(FBoolean.TRUE);
				break;
			}
		}
		// TODO ä»£ç…ä»˜æ•°ï¼šè®¡ç®—ä»£ç…è´¹ç”¨ä½¿ç”¨ï¼Œè‰è¯çš„ä»£ç…ä»˜æ•°ç­‰äºè‰è¯ä»˜æ•?
		// TODO æ ‡æœ¬ç®¡ç†è´¹ç”¨è®¡ç®—ï¼šæ£€éªŒé—¨è¯Šä¸€æ¡åŒ»å˜±å¯¹åº”ä¸€ç»„æ ‡æœ¬é‡‡é›†è´¹ æ£€éªŒå±æ€§ä¸­æ ‡æœ¬ç±»å‹ï¼Œå®¹å™¨ç±»å?
		
		if (ciEmsDto.getSd_srvtp() != null
				&& ciEmsDto.getSd_srvtp().startsWith(IBdSrvDictCodeConst.SD_SRVTP_HERBDRUG)) {
			// 0127036: é—¨è¯Šè‰è¯è°ƒç”¨åŒ»å˜±æ¨¡æ¿ï¼Œå˜±æ‰˜èµ‹å€¼åˆ°å¤‡æ³¨é‡?å¦‚æœæ¨¡æ¿å¤‡æ³¨ä¸ºç©ºï¼Œåˆ™æ‹¼æ¥å¤‡æ³¨
			if (ciOrTmplDTO.getDes_or() == "" || ciOrTmplDTO.getDes_or() == null) {
				if (tmplSrvDTO != null && tmplSrvDTO.getQuan_med() != null) {
//					ciEmsDto.setNote(
//							"æ¯æ—¥1å‰?" + (ciEmsDto.getName_boil() == "" ? "" : ciEmsDto.getName_boil() + "è‡?00ml,")
//									+ tmplSrvDTO.getQuan_med() + " " + medSrvDO.getMed_name() + ","
//									+ ciEmsDto.getName_freq() + "," + ciEmsDto.getName_route());
					ciEmsDto.setNote(CiOrdUtils.genOrdDes(ciEmsDto));

				} else {
//					ciEmsDto.setNote(CiOrdUtils.genOrdDes(ciEmsDto)
//							"æ¯æ—¥1å‰?" + (ciEmsDto.getName_boil() == "" ? "" : ciEmsDto.getName_boil() + "è‡?00ml,")
//									+ medSrvDO.getQuan_med() + " " + medSrvDO.getMed_name() + ","
//									+ ciEmsDto.getName_freq() + "," + ciEmsDto.getName_route());
					ciEmsDto.setNote(CiOrdUtils.genOrdDes(ciEmsDto));
				}
			} else {
				ciEmsDto.setNote(ciOrTmplDTO.getDes_or());
			}

			// ciEmsDto.setNote(ciEmsDto.getDes_or());

		} else {
			// ciEmsDto.setNote();
		}

	}
	

	/**
	 * é€šè¿‡bdæœåŠ¡èµ‹å€¼é¢‘æ¬¡ã€ç”¨æ³•ã€ç”¨æ³•è¦æ±‚ã€ç…æ³•ã€ç…æ³•è¦æ±‚ã€åŒ»å˜±å¤©æ•?
	 * 
	 * @param ciEmsDto
	 * @param tmplSrvDTO
	 * @param medSrvDO
	 * @throws BizException
	 */
	private void setCiEmsDTOUseDetailByMedSrv(CiEnContextDTO envinfo, CiEmsDTO ciEmsDto, MedSrvDO medSrvDO)
			throws BizException {

		// é¢‘æ¬¡
		if (StringUtils.isBlank(ciEmsDto.getId_freq())) {
			ciEmsDto.setId_freq(medSrvDO.getId_freq());
		}

		// è·å–SDä¸­é¢‘æ¬?
		FreqDefDO freqDef = ifreqdefMDORService.findById(ciEmsDto.getId_freq());
		if (freqDef == null) {
			throw new BizException("è·å–é¢‘æ¬¡SDå¤±è´¥ï¼?);
		}

		ciEmsDto.setFg_long(freqDef.getFg_long()); // å¸¸ä¸´æ ‡è¯†
													// ä½é™¢æ ¹æ®é¢‘æ¬¡ä¸­å®šä¹‰çš„ç±»å‹è®¾ç½®å¸¸ä¸´æ ‡è¯†ï¼Œé—¨è¯Šçš„éƒ½ä¸ºfalse
		ciEmsDto.setName_freq(freqDef.getName());// åŒ»å˜±é¢‘æ¬¡åç§°
		ciEmsDto.setFreqct(freqDef.getFreqct()); // é¢‘æ¬¡å‘¨æœŸä¸‹æ¬¡æ•?
		ciEmsDto.setSd_frequnitct(freqDef.getSd_frequnitct()); // é¢‘æ¬¡å‘¨æœŸç±»å‹ç¼–ç 
		ciEmsDto.setFrequnitct(freqDef.getFrequnitct());

		// ä½é™¢
		if (envinfo != null && IBdFcDictCodeConst.SD_CODE_ENTP_IP.equals(envinfo.getCode_entp())) {
			ciEmsDto.setDays_or(null);// åŒ»å˜±å¤©æ•°
		}
		// é¢‘æ¬¡æ˜¯ä¸€æ¬¡çš„åŒ»å˜±å¤©æ•°è®¾ç½®ä¸?
		if (IBdSrvDictCodeConst.SD_FREQNUNITCT_ONCE.equals(freqDef.getFre_code())) {
			ciEmsDto.setDays_or(1);
		}

		// æ ¹æ®å‘¨æœŸç±»å‹ç¡®å®šåŒ»å˜±é»˜è®¤å¤©æ•°ï¼Œä½é™¢åŒ»å˜±å¤©æ•°å­˜åœ?-1
		if (ciEmsDto.getDays_or() == null || ciEmsDto.getDays_or() <= 0) {
			if (IBdSrvDictCodeConst.SD_FREQNUNITCT_WEEK.equals(ciEmsDto.getSd_frequnitct())) { // å¦‚æœé¢‘æ¬¡å‘¨æœŸç±»å‹æ˜¯æ˜ŸæœŸï¼Œè¿”å›ä¸€ä¸ªå‘¨æœŸçš„å¤©æ•°
				ciEmsDto.setDays_or(7);
				// ciEmsDto.setDt_end(fd.getDateTimeAfter(7));
			} else {
				// ä½é™¢
				if (envinfo != null && IBdFcDictCodeConst.SD_CODE_ENTP_IP.equals(envinfo.getCode_entp())) {
					ciEmsDto.setDays_or(null);// åŒ»å˜±å¤©æ•°
				} else {
					ciEmsDto.setDays_or(1);
				}

			}
		}

		// è®¾ç½®ç”¨æ³•idã€åç§?
		if (StringUtils.isNotBlank(ciEmsDto.getId_route())) {

			MedUsageDO medUsage = imedusageRService.findById(ciEmsDto.getId_route()); // ç”¨æ³•
			if (medUsage == null) {
				throw new BizException("è·å–ç”¨æ³•SDå¤±è´¥ï¼?);
			}
			ciEmsDto.setName_route(medUsage.getName());// ç”¨æ³•åç§°
		} else {
			ciEmsDto.setId_route(medSrvDO.getId_route());// ç”¨æ³•
			ciEmsDto.setName_route(medSrvDO.getRoute_name());// ç”¨æ³•åç§°
		}

		// ç”¨æ³•è¦æ±‚ï¼Œè®¾ç½®ç”¨æ³•è¦æ±‚idã€åç§?
		if (StringUtils.isNotBlank(ciEmsDto.getId_routedes())) {
			ciEmsDto.setName_routedes(getName_routes(ciEmsDto.getId_routedes()));
		} else {
			ciEmsDto.setId_routedes(medSrvDO.getId_routedes());
			ciEmsDto.setName_routedes(medSrvDO.getRoutedes_name());
		}

		// è®¾ç½®ç…æ³•idã€åç§?
		if (StringUtils.isNotBlank(ciEmsDto.getId_boil())) {

			// CHerbBoilMdDO cHerbBoilMd =
			// icherbboilmdMDORService.findById(ciEmsDto.getId_boil());
			DAFacade dafa = new DAFacade();
			String sql = "select name  from bd_boil where id_boil='" + ciEmsDto.getId_boil() + "'";
			CHerbBoilMdDO cHerbBoil = (CHerbBoilMdDO) dafa.execQuery(sql, new BeanHandler(CHerbBoilMdDO.class));
			if (cHerbBoil == null) {
				throw new BizException("è·å–ç…æ³•SDå¤±è´¥ï¼?);
			}
			ciEmsDto.setName_boil(cHerbBoil.getName());
		} else {
			ciEmsDto.setId_boil(medSrvDO.getId_boil());
			ciEmsDto.setName_boil(medSrvDO.getBoil_name());
		}

		// ç…æ³•è¦æ±‚
		if (StringUtils.isNotBlank(ciEmsDto.getId_boildes())) {

			// CHerbBoilDesDO cherbBoilDes =
			// icHerbBoilDesDORService.findById(ciEmsDto.getId_boildes());
			DAFacade dafa = new DAFacade();
			String sql = "select name  from bd_boil_des where id_boildes='" + ciEmsDto.getId_boildes() + "'";
			CHerbBoilDesDO cherbBoilDesc = (CHerbBoilDesDO) dafa.execQuery(sql, new BeanHandler(CHerbBoilDesDO.class));

			if (cherbBoilDesc == null) {
				throw new BizException("ç…æ³•è¦æ±‚SDå¤±è´¥ï¼?);
			}
			ciEmsDto.setName_boildes(cherbBoilDesc.getName());
		} else {
			ciEmsDto.setId_boildes(medSrvDO.getId_boildes());
			ciEmsDto.setName_boildes(medSrvDO.getBoildes_name());
		}
	}

	/**
	 * @throws BizException
	 * 
	 */
	private void setMkrSetProperty(CiEmsDTO ciEmsDto, CiEnContextDTO envinfo, CiOrTmplDTO ciOrTmpl, MedSrvDO medSrv)
			throws BizException {

		MedSrvDO[] medSrvs = this.getSetMedSrvDOs(ciOrTmpl);
		// æ„é€ å¥—å†…é¡¹ç›®é›†å?
		if (FBoolean.TRUE.equals(ciOrTmpl.getFg_set())) {

			FMap Srvsetitms = this.getSrvSetitmMap(ciOrTmpl.getId_srv(), medSrvs);
			ciEmsDto.setSrvsetitms(Srvsetitms);
		}

		FArrayList ciEmsSrvList = new FArrayList();
		// å¥—çš„å¤„ç†
		if (FBoolean.TRUE.equals(ciEmsDto.getFg_set())) {
			CiEmsSrvDTO srvdto = new CiEmsSrvDTO();
			this.setCiEmSrvPropertys(ciEmsDto,srvdto, envinfo, null, medSrv);
			this.setCiEmsSrvMeduPropertys(envinfo,srvdto, ciOrTmpl);
			ciEmsSrvList.add(srvdto);
		}

		for (int i = 0; i < medSrvs.length; i++) {

			CiEmsSrvDTO srvdto = new CiEmsSrvDTO();

			// è®¾ç½®CiEmsSrvDTOç›¸å…³å±æ€§ï¼Œç¯å¢ƒã€æœåŠ¡ã€ç‰©å“?
			this.setCiEmSrvPropertys(ciEmsDto,srvdto, envinfo, null, medSrvs[i]);

			// è®¾ç½®é‡ä¿¡æ?
			this.setCiEmsSrvMeduPropertys(envinfo,srvdto, ciOrTmpl);
			srvdto.setSortno(i + 1);// è®¾ç½®æ’åº
			if (FBoolean.TRUE.equals(ciOrTmpl.getFg_set())) {
				srvdto.setId_srv_set(ciOrTmpl.getId_srv());
			}
			srvdto.setCode_srv(medSrv.getCode());
			ciEmsSrvList.add(srvdto);
		}
		ciEmsDto.setEmssrvs(ciEmsSrvList);
		CiEmsSrvDTO srvDTO = (CiEmsSrvDTO) ciEmsSrvList.get(0);
		ciEmsDto.setQuan_medu(srvDTO.getQuan_med());

		if (ciEmsDto.getSd_srvtp() != null
				&& ciEmsDto.getSd_srvtp().startsWith(IBdSrvDictCodeConst.SD_SRVTP_HERBDRUG)) {
			ciEmsDto.setNote(" " + ciEmsDto.getName_boil() + " " + srvDTO.getQuan_med() + "," + ciEmsDto.getName_freq()
					+ "," + ciEmsDto.getName_route());

		} else {
			// ciEmsDto.setNote();
		}

	}

	/**
	 * è·å–CiEmsSrvDTOé›†åˆ
	 * 
	 * @param envinfo
	 *            å½“å‰ç¯å¢ƒå§ä¿¡æ?
	 * @param ciOrTmpl
	 *            åŒ»å˜±æ¨¡æ¿
	 * @param medSrv
	 *            åŸºç¡€æœåŠ¡
	 * @return
	 * @throws BizException
	 */
	private FArrayList getEmssrvs( CiEmsDTO ciEmsDto,CiEnContextDTO envinfo, CiOrTmplDTO ciOrTmpl, MedSrvDO medSrv) throws BizException {

		FArrayList ciEmsSrvList = new FArrayList();
		FArrayList srvlist = ciOrTmpl.getOrtmplsrvs();
		// å¥—çš„å¤„ç†
		/*if (FBoolean.TRUE.equals(medSrv.getFg_set())) {
			CiEmsSrvDTO srvdto = new CiEmsSrvDTO();

			this.setCiEmSrvPropertys(ciEmsDto,srvdto, envinfo, null, medSrv);
			this.setCiEmsSrvMeduPropertys(envinfo,srvdto, ciOrTmpl);
			ciEmsSrvList.add(srvdto);
		}*/

		MedSrvDO tempMedSrv = null;
		for (int i = 0; i < srvlist.size(); i++) {
			CiOrTmplSrvDTO tmplSrv = (CiOrTmplSrvDTO) srvlist.get(i);
			CiEmsSrvDTO srvdto = new CiEmsSrvDTO();
			srvdto.setId_hp(envinfo.getId_hp());
			tempMedSrv = CiOrdAppUtils.getIMedsrvMDORService().findById(tmplSrv.getId_srv());// è·å–æ¯ä¸ªé¡¹ç›®
			// è®¾ç½®CiEmsSrvDTOç›¸å…³å±æ€§ï¼Œç¯å¢ƒã€æ¨¡æ¿ã€æœåŠ¡ã€ç‰©å“?
			this.setCiEmSrvPropertys(ciEmsDto,srvdto, envinfo, tmplSrv, tempMedSrv);
			
			// è®¾ç½®é‡ä¿¡æ?
			if (tmplSrv.getQuan_total_medu()!=null) {
				srvdto.setQuan_cur(tmplSrv.getQuan_total_medu());
				srvdto.setQuan_total_medu(tmplSrv.getQuan_total_medu());
			}else{
				this.setCiEmsSrvMeduPropertys(envinfo,srvdto, ciOrTmpl,ciEmsDto);
			}
			//this.setCiEmsSrvMeduPropertys(envinfo,srvdto, ciOrTmpl.getDays_or(), ciOrTmpl.getOrders());
			srvdto.setSortno(i + 1);// è®¾ç½®æ’åº
			// æ˜¯å¥—æœåŠ¡æ—¶æ‰è®¾ç½®id_srv_setå±æ€?2016-11-28
			if (FBoolean.TRUE.equals(medSrv.getFg_set())) {
				srvdto.setId_srv_set(ciOrTmpl.getId_srv());
			}
			srvdto.setCode_srv(tempMedSrv.getCode());
			srvdto.setFg_skintest(tmplSrv.getFg_skintest());
			ciEmsSrvList.add(srvdto);
		}
		return ciEmsSrvList;
	}

	

	/**
	 * è®¾ç½®CiEmsSrvDTOå¯¹è±¡å±æ€?
	 * 
	 * @param srvdto
	 * @param envinfo
	 * @param tmplSrv
	 *            åŒ»å˜±æ¨¡æ¿ï¼ˆç»„å¥—æ•°æ®è½¬æ¢è¯¥å€¼ä¸ºnullï¼?
	 * @param medSrv
	 * @throws BizException
	 */
	private void setCiEmSrvPropertys(CiEmsDTO ciEmsDTO,CiEmsSrvDTO srvdto, CiEnContextDTO envinfo, CiOrTmplSrvDTO tmplSrv,
			MedSrvDO medSrv) throws BizException {

		// è®¾ç½®ç¯å¢ƒç›¸å…³å±æ€?
		this.setCiEmsSrvEnvinfoPropertys(srvdto, envinfo);
		
		// è®¾ç½®æœåŠ¡ç›¸å…³å±æ€?
		this.setCiEmsSrvMedSrvPropertys(srvdto, medSrv, envinfo);
		if (tmplSrv != null) { // åŒ»å˜±æ¨¡æ¿è¿›æ¥çš„ä¸ºç©?
			// è®¾ç½®æ¨¡æ¿ä¸­çš„å±æ€?
			this.setCiEmSrvTmplPropertys(srvdto, tmplSrv);
			// è®¾ç½®é¢‘æ¬¡ã€ç”¨æ³•ã€ç”¨æ³•è¦æ±‚ã€ç…æ³•ã€ç…æ³•è¦æ±?
			this.setCiEmsSrvUseDetail(srvdto, medSrv);
			if (FBoolean.TRUE.equals(medSrv.getFg_ctm())&&!StringUtils.isBlank(tmplSrv.getName_selfsrv())) {
				srvdto.setName_srv(tmplSrv.getName_selfsrv());
			}
		}
		// è®¾ç½®ç‰©å“ç›¸å…³å±æ€?
		this.setCiEmsSrvMmPropertys(ciEmsDTO,srvdto, envinfo, medSrv);
		
		
		// è®¾ç½®æ‰§è¡Œç§‘å®¤ç›¸å…³å±æ€?
		//this.setCiEmsSrvOrWfDept(srvdto, envinfo, medSrv);

		// åŒ»ä¿å°±è¯Šï¼Œå¹¶ä¸”éƒ½æ˜¯ä¿å†…è¯Šæ–­æ—¶ä¸ºåŒ»ä¿å°±è¯Šï¼Œå¦åˆ™ä¸ºè‡ªè´¹ï¼ˆä¿å¤–ï¼?
		if (envinfo.getId_hp() != null && HpBeyondEnum.HPDIAG.equals(envinfo.getEu_hpbeyond())) {
			srvdto.setFg_selfpay(FBoolean.FALSE);// ä¿å†…ï¼Œéè‡ªè´¹
		} else {
			srvdto.setFg_selfpay(FBoolean.TRUE);// ä¿å¤– ã€è‡ªè´?
		}

	}

	/**
	 * è®¾ç½®ç¯å¢ƒç›¸å…³å±æ€?
	 * 
	 * @param srvdto
	 *            æœåŠ¡é¡¹ç›®
	 * @param envinfo
	 *            å½“å‰ç¯å¢ƒ
	 */
	private void setCiEmsSrvEnvinfoPropertys(CiEmsSrvDTO srvdto, CiEnContextDTO envinfo) {

		srvdto.setStatus(DOStatus.NEW);

		srvdto.setId_dep_srv(envinfo.getId_dep_or());// å¼€ç«‹ç§‘å®?
		srvdto.setId_ward_srv(envinfo.getId_dep_ns());// å¼€ç«‹ç—…åŒºï¼Œé—¨è¯Šè¯¥å€¼ä¸ºç©ºï¼Œä½é™¢æ—¶ä¼šæœ‰å€?
		srvdto.setId_emp_srv(envinfo.getId_emp_or());// å¼€ç«‹äººå‘?
		srvdto.setDt_create_srv(CiOrdAppUtils.getServerDateTime());// å¼€ç«‹æ—¶é—?
		srvdto.setId_hp(envinfo.getId_hp());// ä¸»åŒ»ä¿è®¡åˆ?

		srvdto.setEu_sourcemd(OrSrvSourceFromEnum.PHYSIAN);// åŒ»ç–—å•é¡¹ç›®æ•°æ®æ¥æºæ–¹å¼?
	}

	/**
	 * è®¾ç½®æ¨¡æ¿ä¸­ç›¸å…³å±æ€?
	 * 
	 * @param srvdto
	 * @param envinfo
	 * @param medSrv
	 * @throws BizException
	 */
	private void setCiEmSrvTmplPropertys(CiEmsSrvDTO srvdto, CiOrTmplSrvDTO tmplSrv) throws BizException {

		// srvdto.setId_orsrv(tmplSrv.getId_orsrv());//åŒ»ç–—å•é¡¹ç›®ä¸»é”®æ ‡è¯?
		// srvdto.setId_or(tmplSrv.getId_or());//åŒ»ç–—å?
		// srvdto.setSortno(tmplSrv.getSortno());// åºå· å¾ªç¯æ—¶ç»Ÿä¸€è®¾ç½®
		srvdto.setId_srv(tmplSrv.getId_srv());// åŒ»ç–—æœåŠ¡
		srvdto.setFg_self(tmplSrv.getFg_selfsrv()); // è‡ªå®šä¹‰æœåŠ¡æ ‡è¯?
		if (FBoolean.TRUE.equals(srvdto.getFg_self())) { // è‡ªå®šä¹‰æœåŠ¡åï¼Œåªæœ‰å°±è¯Šå†å²ä¼šå‡ºç°è‡ªå®šä¹‰æœåŠ?
			srvdto.setName_srv(tmplSrv.getName_selfsrv());
		}
		srvdto.setFg_set(tmplSrv.getFg_set()); // TODO å¥—å±æ€?
												// å¥—å†…é¡¹ç›®ï¼ŒåŸºæœ¬æœåŠ¡ï¼Œå¥—å±æ€§éƒ½åº”è¯¥æ˜¯false
												// ,è‡ªå®šä¹‰æœåŠ¡æœ‰taoæ¦‚å¿µæ²¡ï¼Ÿ
		if(StringUtils.isNotEmpty(tmplSrv.getId_srvtp())) {
			srvdto.setId_srvtp(tmplSrv.getId_srvtp());// æœåŠ¡ç±»å‹  mantis:0181513 æ¨¡æ¿å¼€ç«‹çš„idæœ‰ä¸ºç©ºçš„æƒ…å†µ 
		}
		if(StringUtils.isNotEmpty(tmplSrv.getSd_srvtp())) {
			srvdto.setSd_srvtp(tmplSrv.getSd_srvtp());// æœåŠ¡ç±»å‹ç¼–ç 
		}
		if(StringUtils.isNotEmpty(tmplSrv.getId_freq())) {
			srvdto.setId_freq(tmplSrv.getId_freq());// é¢‘æ¬¡
		}
		if(StringUtils.isNotEmpty(tmplSrv.getId_route())) {
			srvdto.setId_route(tmplSrv.getId_route());// ç”¨æ³•
		}
		if(StringUtils.isNotEmpty(tmplSrv.getId_routedes())) {
			srvdto.setId_routedes(tmplSrv.getId_routedes());// ç”¨æ³•è¦æ±‚
		}
		if(StringUtils.isNotEmpty(tmplSrv.getId_boil())) {
			srvdto.setId_boil(tmplSrv.getId_boil());// ç…æ³•
		}
		if(StringUtils.isNotEmpty(tmplSrv.getId_boildes())) {
			srvdto.setId_boildes(tmplSrv.getId_boildes());// ç…æ³•è¦æ±‚
		}
		if(tmplSrv.getQuan_med() != null) {
			srvdto.setQuan_med(tmplSrv.getQuan_med());// åŒ»å­¦å•ä½æ•°å€¼ï¼ˆå‰‚é‡ï¼?
		}
		if(StringUtils.isNotEmpty(tmplSrv.getId_unit_med())) {
			srvdto.setId_unit_med(tmplSrv.getId_unit_med());// åŒ»å­¦å•ä½ï¼ˆè®¡é‡å•ä½ï¼‰
		}
		if(tmplSrv.getId_unit_med()!=null){
			MeasDocDO[] measDocDO = getMeasDocDO(tmplSrv.getId_unit_med());
			if (measDocDO!=null&&measDocDO.length >0) {
				srvdto.setName_unit_med(measDocDO[0].getName());
			}
		}
		if (tmplSrv.getQuan_total_medu()!=null&&tmplSrv.getSd_srvtp().startsWith("01")) {
			 srvdto.setQuan_total_medu(tmplSrv.getQuan_total_medu()); // æ€»é‡ TODO
			 srvdto.setId_unit_sale(tmplSrv.getId_unit_sale());
		}
		
		// å¯¹äºæœåŠ¡å¥—æ¥è¯´ï¼Œç¼ºå°‘æ€»é‡å•ä½ æ€»é‡åº”è¯¥æ”¾åˆ°åé¢è®¡ç®—

		srvdto.setId_dep(tmplSrv.getId_dep_mp()); // æ‰§è¡Œç§‘å®¤
		srvdto.setId_mm(tmplSrv.getId_mm());// ç‰©å“
		//æœåŠ¡åˆ†ç±»å¼€ç«‹åŒ»å˜±çš„æ—¶å€?å½“å‰å‰‚é‡ æ¢ç®—ç³»æ•°ç­‰å€¼ä¸ºç©?
		if (tmplSrv.getFactor_cur()==null) {
			srvdto.setQuan_medu_cur(tmplSrv.getQuan_med());
			srvdto.setId_medu_cur(tmplSrv.getId_unit_med());
			srvdto.setFactor_medu_cur(new FDouble(1));
		}else{
			srvdto.setQuan_medu_cur(tmplSrv.getQuan_medu_cur());
			srvdto.setId_medu_cur(tmplSrv.getId_medu_cur());
			srvdto.setFactor_medu_cur(tmplSrv.getFactor_cur());
		}
		
		if(tmplSrv.getId_medu_cur()!=null){
			MeasDocDO[] measDocDO = getMeasDocDO(tmplSrv.getId_medu_cur());
			if (measDocDO!=null&&measDocDO.length >0) {
				srvdto.setName_unit_medu_cur(measDocDO[0].getName());
			}
		}
	}

	/**
	 * é€šè¿‡MedSrvDOè¡¥å…¨CiEmsSrvDTOä¸­ç¼ºå¤±çš„å±æ€?
	 * 
	 * @param srvdto
	 *            CiEmsSrvDTOå¯¹è±¡
	 * @param medSrv
	 *            æœåŠ¡å¯¹è±¡
	 * @param sortNo
	 *            æ’åºå?
	 * @param idSrvSet
	 *            æ‰€å±çš„æœåŠ¡å¥—id
	 * @throws BizException
	 */
	private void setCiEmsSrvMedSrvPropertys(CiEmsSrvDTO srvdto, MedSrvDO medSrv, CiEnContextDTO envinfo)
			throws BizException {

		// é¢‘æ¬¡
		if (StringUtils.isBlank(srvdto.getId_freq())) {
			srvdto.setId_freq(medSrv.getId_freq());
		}

		// è®¾ç½®ç”¨æ³•id
		if (StringUtils.isBlank(srvdto.getId_route())) {
			srvdto.setId_route(medSrv.getId_route());
		}

		// ç”¨æ³•è¦æ±‚ï¼Œè®¾ç½®ç”¨æ³•è¦æ±‚idã€åç§?
		if (StringUtils.isBlank(srvdto.getId_routedes())) {
			srvdto.setId_routedes(medSrv.getId_routedes());
		}

		// è®¾ç½®ç…æ³•id
		if (StringUtils.isBlank(srvdto.getId_boil())) {
			srvdto.setId_boil(medSrv.getId_boil());
		}

		// ç…æ³•è¦æ±‚
		if (StringUtils.isBlank(srvdto.getId_boildes())) {
			srvdto.setId_boildes(medSrv.getId_boildes());
		}

		// srvdto.setId_orsrv(tmplSrv.getId_orsrv());//åŒ»ç–—å•é¡¹ç›®ä¸»é”®æ ‡è¯?
		// srvdto.setId_or(tmplSrv.getId_or());//åŒ»ç–—å?
		// srvdto.setSortno(sortNo);// åºå·

		if (StringUtils.isBlank(srvdto.getId_srv())) {
			srvdto.setId_srv(medSrv.getId_srv());// åŒ»ç–—æœåŠ¡
		}

		if (StringUtils.isBlank(srvdto.getId_srvtp())) {
			srvdto.setId_srvtp(medSrv.getId_srvtp());// æœåŠ¡ç±»å‹
		}

		if (StringUtils.isBlank(srvdto.getSd_srvtp())) {
			srvdto.setSd_srvtp(medSrv.getSd_srvtp());// æœåŠ¡ç±»å‹ç¼–ç 
		}

		srvdto.setCode_srv(medSrv.getCode());// åŒ»ç–—æœåŠ¡ç¼–ç 

		srvdto.setName_srv(medSrv.getName());// åŒ»ç–—æœåŠ¡åç§°
		srvdto.setId_srvca(medSrv.getId_srvca());// æœåŠ¡é¡¹ç›®åŸºæœ¬åˆ†ç±»
		if (!OrSourceFromEnum.IIHSRVCAHELPER.equals(envinfo.getEu_orsrcmdtp())) {
			if (isFDoubleEmpty(srvdto.getQuan_med())) {
				srvdto.setQuan_med(medSrv.getQuan_med());// åŒ»å­¦å•ä½æ•°å€¼ï¼ˆå‰‚é‡ï¼?
			}
		}
		if (StringUtils.isBlank(srvdto.getId_unit_med())) {
			srvdto.setId_unit_med(medSrv.getId_unit_med());// åŒ»å­¦å•ä½(å‰‚é‡å•ä½)
		}
		srvdto.setName_unit_med(medSrv.getMed_name()); // åŒ»å­¦å•ä½åç§°ï¼ˆå‰‚é‡å•ä½åç§°ï¼‰
		srvdto.setFg_mm(medSrv.getFg_mm());// ç‰©å“æ ‡è¯†
		srvdto.setFg_set(medSrv.getFg_set());// æœåŠ¡å¥—æ ‡è¯?å¥—å†…é¡¹ç›®å…¨è®¾ç½®ä¸ºFalse
		MedSrvSetItemDO medSrvSetItem = setItemSrvMap.get(srvdto.getId_srv());
		if (medSrvSetItem != null) {
			srvdto.setFg_or(medSrvSetItem.getFg_clinical());// åŒ»å˜±æ ‡è¯†
		} else {
			srvdto.setFg_or(medSrv.getFg_or());// åŒ»å˜±æ ‡è¯†
		}

		srvdto.setFg_bl(medSrv.getFg_bl());// è´¹ç”¨æ ‡è¯†
		srvdto.setEu_blmd(medSrv.getEu_blmd());// åˆ’ä»·æ–¹å¼
		MedSrvRisDO medSrvRis = srvRisMap.get(srvdto.getId_srv());
		if (medSrvRis != null && !FBoolean.TRUE.equals(srvdto.getFg_set())) {
			srvdto.setId_body(medSrvRis.getId_body());// éƒ¨ä½
			srvdto.setSd_body(medSrvRis.getSd_body());// éƒ¨ä½ç¼–ç 
			srvdto.setBody_name(medSrvRis.getName_body());// éƒ¨ä½åç§°
			srvdto.setId_pos(medSrvRis.getId_pos());// ä½“ä½
			srvdto.setSd_pos(medSrvRis.getSd_pos());// ä½“ä½ç¼–ç 
			srvdto.setPos_name(medSrvRis.getName_pos());// ä½“ä½åç§°
		}
		srvdto.setEu_sourcemd(OrSrvSourceFromEnum.PHYSIAN);// åŒ»ç–—å•é¡¹ç›®æ•°æ®æ¥æºæ–¹å¼?
		srvdto.setFg_selfsrv(medSrv.getFg_ctm());// è‡ªå®šä¹‰æœåŠ¡æ ‡è¯?
		srvdto.setId_primd(medSrv.getId_primd());// å®šä»·æ¨¡å¼
		srvdto.setInnercode_srvca(medSrv.getSrvca_code());// æœåŠ¡åˆ†ç±»å†…ç 
	}

	/**
	 * è®¾ç½®CiEmsSrvDTOä¸­ç‰©å“ç›¸å…³å±æ€?
	 * 
	 * @param srvdto
	 * @param envinfo
	 * @param medSrv
	 * @throws BizException
	 */
	private void setCiEmsSrvMmPropertys(CiEmsDTO ciEmsDTO,CiEmsSrvDTO srvdto, CiEnContextDTO envinfo, MedSrvDO medSrv)
			throws BizException {

		if (!FBoolean.TRUE.equals(medSrv.getFg_mm())) {
			return;
		}
		MeterialAggDO meterialAgg = null;
		if (StringUtils.isNotBlank(srvdto.getId_mm())) {
			meterialAgg = CiOrdAppUtils.getIMeterialRService().findById(srvdto.getId_mm());
		} else {
			String whereStr = MeterialDODesc.TABLE_ALIAS_NAME + "." + MeterialDO.ID_SRV + " = '" + medSrv.getId_srv()
					+ "'";
			MeterialAggDO[] meterAggDO = CiOrdAppUtils.getIMeterialRService().find(whereStr, MeterialDO.ID_SRV,
					FBoolean.FALSE);
			if (meterAggDO != null && meterAggDO.length > 0) {
				meterialAgg = meterAggDO[0];
			}
		}

		if (meterialAgg == null) {
			OrdBizLogger.info(envinfo, "æœåŠ¡ã€? + medSrv.getName() + "ã€‘æ²¡æœ‰æŸ¥è¯¢åˆ°å…³è”çš„ç‰©å“ï¼");
			throw new BizRuntimeException("æœåŠ¡ã€? + medSrv.getName() + "ã€‘æ²¡æœ‰æŸ¥è¯¢åˆ°å…³è”çš„ç‰©å“ï¼");
		}

		MeterialDO meterial = meterialAgg.getParentDO();
		DAFacade dafacade = new DAFacade();
		StringBuffer sql = new StringBuffer();
		// æŸ¥è¯¢è¯¥ç‰©å“è¯å“å±æ€§æ˜¯å¦æŠ—èŒç´ ç”¨è¯
		sql.append(" select fg_anti  from bd_srv_drug where id_srv = '" + medSrv.getId_srv() + "'");
		List<String> list = (List<String>) dafacade.execQuery(sql.toString(), new ColumnListHandler());
		if (!CiOrdUtils.isEmpty(list)) {
			FBoolean fg_anti = new FBoolean(list.get(0));
			if (fg_anti != null && fg_anti.booleanValue()) {
				if (CiOrdUtils.isEmpty(srvdto.getFg_propc())) {
					srvdto.setFg_propc(FBoolean.FALSE); // emsordrug.Fg_propc
														// å¯èƒ½å­˜åœ¨ç©ºå€?
				}
			}
		}
		srvdto.setFg_skintest(meterial.getFg_skin());
		srvdto.setId_srvskin(meterial.getId_srvskin());
		srvdto.setId_unit_med(meterial.getId_unit_med());
		srvdto.setName_unit_med(meterial.getUnit_med_name());
		// å•†å“æ¨¡å¼æ—¶æ‰ç”¨bd_mmè¿›è¡Œèµ‹å€?
		if (IBdMmParamValueConst.DRUGMCPROPMM_DRUG.equals(drugManagementModel)) {
			if (StringUtils.isEmpty(srvdto.getId_boil())) {
				srvdto.setId_boil(meterial.getId_boil());
				srvdto.setName_boil(meterial.getBoil_name());
			}
			if (StringUtils.isEmpty(srvdto.getId_boildes())) {
				srvdto.setId_boildes(meterial.getId_boildes());
				srvdto.setName_boildes(meterial.getBoildes_name());
			}
			if (StringUtils.isEmpty(srvdto.getId_route())) {
				srvdto.setId_route(meterial.getId_route());
				srvdto.setName_route(meterial.getRoute_name());
			}
			if (StringUtils.isEmpty(srvdto.getId_freq())) {
				srvdto.setId_freq(meterial.getId_freq());
				srvdto.setName_freq(meterial.getFreq_name());
			}
		}
		// srvdto.setQuan_cur(tmplSrv.getQuan_cur());//æ€»é‡_å½“å‰
		/// srvdto.setQuan_base(meterial.getQuan_base());//æ€»é‡_åŸºæœ¬
		srvdto.setId_mm(meterial.getId_mm());// ç‰©å“id
		srvdto.setName_mm(meterial.getName());// ç‰©å“åç§°
		srvdto.setSpec_mm(meterial.getSpec());// è§„æ ¼
		// è·å–ç‰©å“çš„æœ‰æ•ˆå•ä½?
		MaterialUnitDTO[] materIalUnits = BDMmDoseUnitInfoCache.getMaterialUnitInfos(envinfo.getCode_entp(), new String[] {srvdto.getId_mm()});
		if(srvdto.getId_unit_sale()==null){
			srvdto.setId_unit_sale(materIalUnits[0].getId_measdoc());// é›¶å”®å•ä½
			srvdto.setName_unit_sale(materIalUnits[0].getMeasdoc_name());// é›¶å”®å•ä½åç§°
		}else{
			for (MaterialUnitDTO materialUnitDTO : materIalUnits) {
				if (materialUnitDTO.getId_measdoc().equals(srvdto.getId_unit_sale())) {
					srvdto.setName_unit_sale(materialUnitDTO.getMeasdoc_name());// é›¶å”®å•ä½åç§°
				}
			}
		}
		

		srvdto.setId_unit_base(meterial.getId_unit_pkgbase());// åŸºæœ¬å•ä½
		srvdto.setName_unit_base(meterial.getPkgbase_name());// åŸºæœ¬å•ä½åç§°
		// srvdto.setQuan_num_base(meterial.getParentDO().getQuan_num_base());//å•æ¬¡æ•°é‡_åˆ†å­
		// srvdto.setQuan_den_base(meterial.getParentDO().getQuan_den_base());//å•æ¬¡æ•°é‡_åˆ†æ¯
		// srvdto.setPrice_cur(tmplSrv.getPrice_cur());//å‚è€ƒä»·å½“å‰
		// srvdto.setQuan_bed_medu(tmplSrv.getQuan_bed_medu());//åºŠè¾¹é‡_åŒ»å­¦
		srvdto.setFactor_cb(materIalUnits[0].getFactor());// å½“å‰åŸºæœ¬æ¢ç®—ç³»æ•°
		srvdto.setFactor_mb(meterial.getFactor_mb());// åŒ»ç–—åŸºæœ¬æ¢ç®—ç³»æ•°
		// srvdto.setFactor(getSaleFactor(meterial,srvdto.getId_unit_sale()));//æ€»é‡å•ä½æ¢ç®—ç³»æ•°
//		OrWfDeptInfoDTO wf = getMpDeptID(envinfo, medSrv);// è¯å“ä»“åº“
//		if (null != wf) {
//			srvdto.setId_dep_wh(wf.getId_dept_wh());// ä»“åº“
//			srvdto.setName_dep_wh(wf.getName_dept_wh()); // ä»“åº“çš„åç§?
//		}
		//è®¾ç½®æ‰§è¡Œç§‘å®¤ç›¸å…³å±æ€? ä»“åº“éœ€è¦å…ˆæŸ¥å‡ºæ?åé¢è®¡ç®—ä»·æ ¼éœ€è¦ä»“åº“ä½œä¸ºå‚æ•?
		this.setCiEmsSrvOrWfDept(ciEmsDTO,srvdto, envinfo, medSrv);
		FDouble pricce = this.getMMwhPrice(meterial.getId_mm(), materIalUnits[0].getId_measdoc(),
				srvdto.getId_dep_wh());
		srvdto.setPrice_cur(pricce);
		srvdto.setPrice(pricce);
		if (iih.bd.bc.udi.pub.IBdFcDictCodeConst.SD_CODE_ENTP_IP.equals(envinfo.getCode_entp())) {
			srvdto.setSd_roundmd(meterial.getSd_mupkgutp());// ä½é™¢-å–æ•´æ–¹å¼
		} else {
			srvdto.setSd_roundmd(meterial.getSd_opmutp());// é—¨è¯Š-å–æ•´æ–¹å¼
		}
		srvdto.setId_mupkgutp(meterial.getId_mupkgutp());// ç‰©å“ä½é™¢å–æ•´æ¨¡å¼id
		srvdto.setSd_mupkgutp(meterial.getSd_mupkgutp());// ç‰©å“ä½é™¢å–æ•´æ¨¡å¼d
		srvdto.setId_opmutp(meterial.getId_opmutp());// ç‰©å“é—¨è¯Šå–æ•´æ¨¡å¼id
		srvdto.setSd_opmutp(meterial.getSd_opmutp());// ç‰©å“é—¨è¯Šå–æ•´æ¨¡å¼sd
		// è·å–è¯å“å±æ€?ä»£ä¼˜åŒ?æŸ¥è¯¢ä½ç½®ä¸å¯¹
		String whereStr = MedSrvDrugDO.ID_SRV + "='" + medSrv.getId_srv() + "'";
		MedSrvDrugDO[] drugDO = CiOrdAppUtils.getIMedSrvDrugDORService().find(whereStr, MedSrvDrugDO.ID_SRV,
				FBoolean.FALSE);
		if (drugDO != null && drugDO.length > 0) {
			srvdto.setId_dosage(drugDO[0].getId_dosage());// è¯å“å‰‚å‹
			srvdto.setSd_dosage(drugDO[0].getSd_dosage());// è¯å“å‰‚å‹ç¼–ç 
			srvdto.setId_pharm(drugDO[0].getId_pharm());// è¯ç†åˆ†ç±»
			srvdto.setSd_pharm(drugDO[0].getSd_pharm());// è¯ç†åˆ†ç±»ç¼–ç 
			srvdto.setId_pois(drugDO[0].getId_pois());// æ¯’éº»åˆ†ç±»
			srvdto.setSd_pois(drugDO[0].getSd_pois());// æ¯’éº»åˆ†ç±»ç¼–ç 
			srvdto.setId_anti(drugDO[0].getId_anti());// æŠ—èŒè¯åˆ†ç±?
			srvdto.setSd_anti(drugDO[0].getSd_anti());// æŠ—èŒè¯åˆ†ç±»ç¼–ç ?
		}

		srvdto.setId_mmtp(meterial.getId_mmtp());// ç‰©å“ç±»å‹
		srvdto.setSd_mmtp(meterial.getSd_mmtp());// ç‰©å“ç±»å‹ç¼–ç 
		srvdto.setName_mmtp(meterial.getMmca_name());// ç‰©å“ç±»å‹åç§°
		srvdto.setId_sup(meterial.getId_sup());// å‚å®¶
		srvdto.setName_sup(meterial.getFactory_name());// å‚å®¶åç§°
		srvdto.setCode_mm(meterial.getCode());// ç‰©å“ç¼–ç 
		srvdto.setSd_val(meterial.getSd_val());// ä»·å€¼åˆ†ç±»ç¼–ç ?
		srvdto.setId_val(meterial.getId_val());// ä»·å€¼åˆ†ç±?
		srvdto.setIndica(meterial.getIndica());// é€‚åº”ç—?
		srvdto.setConstr(meterial.getConstr());// ç¦å¿Œç—?
		srvdto.setReact(meterial.getReact());// ä¸è‰¯ååº”
		// srvdto.setGuide(meterial.getGuide());//ä¸»è¦ä½œç”¨
		srvdto.setFg_otc(meterial.getFg_otc());// OTCæ ‡è¯†

		// srvdto.setPrice(meterial.getPrice());// é›¶å”®ä»?
		//å½“å‰å‰‚é‡å’Œå•ä½èµ‹å€?
		/*srvdto.setId_medu_cur(srvdto.getId_medu_cur());
		srvdto.setQuan_medu_cur(srvdto.getQuan_medu_cur());
		srvdto.setFactor_medu_cur(new FDouble("1"));*/
		MeasDocDO[] measDocDO = getMeasDocDO(srvdto.getId_medu_cur());
		if (measDocDO!=null&&measDocDO.length>0) {
			srvdto.setName_unit_medu_cur(measDocDO[0].getName());
		}
		
	}
	
	public MeasDocDO[] getMeasDocDO(String id_unit_med) throws BizException{

		MeasDocDOQuery qry=new MeasDocDOQuery(id_unit_med);
		MeasDocDO[] rtn = (MeasDocDO[])AppFwUtil.getDORstWithDao(qry, MeasDocDO.class);
		 return rtn;
	}

	/**
	 * è®¾ç½®æœåŠ¡ä»·æ ¼
	 * 
	 * @param srvdto
	 * @param medSrv
	 * @throws BizException
	 */
	private void setCiEmsPrice(CiEnContextDTO envinfo, CiEmsDTO ciEmsDto, MedSrvDO medSrv) throws BizException {

		String id_pripat = envinfo.getId_pripat();
		FArrayList emssrvList = ciEmsDto.getEmssrvs();
		CiEmsSrvDTO srvdto = (CiEmsSrvDTO) emssrvList.get(0);
		// å¦‚æœä»·æ ¼ä¸ä¸ºç©ºï¼Œæˆ–è€…å¥—å†…é¡¹ç›®ä¸è¿›è¡Œä»·æ ¼è®¡ç®—
		if (srvdto.getPrice() != null) {
			return;
		}
		//å¥—æœ¬èº«æ˜¯ä¸ä»˜è´¹çš„ï¼Œä¸ç”¨å†ç®—äº†ï¼Œzhangwq20191108
		if (FBoolean.TRUE.equals(ciEmsDto.getFg_set())){
			return;
		}
		// æ„é€ æŸ¥è¯¢ä»·æ ¼å‚æ•?
		BdSrvPriCalParamDTO param = new BdSrvPriCalParamDTO();
		param.setId_srv(medSrv.getId_srv());
		param.setName_srv(medSrv.getName());
		param.setId_primd(medSrv.getId_primd());
		param.setNum(0);
		// å¦‚æœæ˜¯å¥—ï¼Œæ ¹æ®å¥—å†…é¡¹ç›®è®¡ç®—ä»·æ ? æ’é™¤æœåŠ¡å¥—å•é€‰æ¨¡å¼?
		if (FBoolean.TRUE.equals(ciEmsDto.getFg_set()) &&  !FBoolean.TRUE.equals(medSrv.getFg_setradio()) && srvSetItemsMap.size()>0) {

			// è®¡ç®—è´¹ç”¨çš„å¥—å†…é¡¹ç›®ä¸ªæ•?
			int clinicalBlCnt = 0;
			List<MedSrvSetItemDO> srvsetitmList = srvSetItemsMap.get(ciEmsDto.getId_srv());
			FArrayList list = new FArrayList();
			if (srvsetitmList == null || srvsetitmList.size() == 0) {
				OrdBizLogger.info(envinfo, "æœåŠ¡[" + ciEmsDto.getName() + "]æœªæ‰¾åˆ°å¯¹åº”çš„å¥—å†…é¡¹ç›®ï¼?);
				throw new BizRuntimeException("æœåŠ¡[" + ciEmsDto.getName() + "]æœªæ‰¾åˆ°å¯¹åº”çš„å¥—å†…é¡¹ç›®ï¼?);
			}
			for (MedSrvSetItemDO medSrvSetItem : srvsetitmList) {

				// éä¸´åºŠçš„ä¸è®¡ç®—ä»·æ ?
				if (!FBoolean.TRUE.equals(medSrvSetItem.getFg_clinical())) {
					continue;
				}

				BdSrvPriCalParamDTO srvParamDTO = new BdSrvPriCalParamDTO();
				srvParamDTO.setId_primd(medSrv.getId_primd());
				srvParamDTO.setNum(1);
				srvParamDTO.setId_srv(medSrvSetItem.getId_srv_itm());

				// è¯Šç–—é¡¹ç›®ä¸­å‹¾é€‰ä¸´åºŠä»·æ ¼è®¡ç®—æ ‡è¯†çš„æ‰è®¡ç®—ä¸ªæ•?
				if (FBoolean.TRUE.equals(medSrvSetItem.getFg_clinical_bl())) {
					clinicalBlCnt++;
				}
				list.add(srvParamDTO);
			}

			param.setNum(clinicalBlCnt);
			param.setSrvsetitms(list);
		}

		CiOrBdSrvPricesCalByPriModeBP bp = new CiOrBdSrvPricesCalByPriModeBP();
		MedSrvPriceDO medSrvPrice = bp.exec(param, id_pripat);
		// å­˜åœ¨ä¸è®¡è´¹æœåŠ?
		if (null != medSrvPrice) {
			srvdto.setPrice(medSrvPrice.getPrice_ratio());
			srvdto.setPri_ratio(medSrvPrice.getPrice_ratio());
			srvdto.setPri_std(medSrvPrice.getPrice_std());
			srvdto.setPrice_cur(medSrvPrice.getPrice_ratio());
			srvdto.setId_pripat(id_pripat);
		} else {
			srvdto.setPrice(FDouble.ZERO_DBL);
			srvdto.setPri_ratio(FDouble.ONE_DBL);
			srvdto.setPri_std(FDouble.ZERO_DBL);
			srvdto.setPrice_cur(FDouble.ZERO_DBL);
			srvdto.setId_pripat(id_pripat);
		}

	}

	/**
	 * è®¡ç®—CiEmsSrvDTOä¸­çš„æ€»é‡
	 * 
	 * @param srvdto
	 *            æœåŠ¡é¡¹ç›®å¯¹è±¡
	 * @param useDays
	 *            ä½¿ç”¨å¤©æ•°
	 * @param orders
	 *            åŒ»å˜±ä»˜æ•°ï¼ˆè‰è¯ä½¿ç”¨ï¼‰
	 * @throws BizException
	 */
	private void setCiEmsSrvMeduPropertys(CiEnContextDTO envinfo,CiEmsSrvDTO srvdto, CiOrTmplDTO ciOrTmpl ) throws BizException {
		
		Integer useDays=ciOrTmpl.getDays_or();
		Integer orders=ciOrTmpl.getOrders();

		useDays = useDays == null ? 1 : useDays;
		orders = orders == null ? 7 : orders;

		CalQuantumBP calQuantumBP = new CalQuantumBP();
		// å¦‚æœæ˜¯ç‰©å“ï¼Œé‡æ–°è·å–ç‰©å“å¯¹è±¡ TODO è®¡ç®—æ€»é‡
		if (FBoolean.TRUE.equals(srvdto.getFg_mm())) {
			// è®¡ç®—è¯å“æ€»é‡
			if (FBoolean.TRUE.equals(srvdto.getFg_dose_anoma())) { // å˜åŠ¨ç”¨è¯è®¡ç®—æ€»é‡
				GetDrugTotalQuan4DoseBP bp = new GetDrugTotalQuan4DoseBP();
				srvdto.setQuan_cur(new FDouble(bp.exec(srvdto, useDays)));
			} else {
				if (srvdto.getSd_srvtp().startsWith(IBdSrvDictCodeConst.SD_SRVTP_HERBDRUG)) {
					srvdto.setQuan_cur(calQuantumBP.getMMQuantum(envinfo.getCode_entp(), envinfo.getFg_pres_outp(), orders, srvdto.getId_mm(), srvdto.getId_unit_sale(), srvdto.getQuan_med()));
				}else{
					srvdto.setQuan_cur(calQuantumBP.getMMQuantum(envinfo.getCode_entp(), envinfo.getFg_pres_outp(), ciOrTmpl.getDt_effe(),useDays, srvdto.getId_freq(), srvdto.getId_mm(), srvdto.getId_unit_sale(), srvdto.getQuan_med()));
				}
				srvdto.setQuan_total_medu(srvdto.getQuan_cur());
			}
			// é¢†é‡å¤©æ•°
			srvdto.setDays_available(new GetDrugDaysOfAvailable().exec(srvdto));
		} else {
			// è®¡ç®—éè¯å“æœåŠ¡æ€»é‡
			if(ciOrTmpl.getTimes()!=null){
				srvdto.setQuan_cur(calQuantumBP.getQuantum(srvdto.getQuan_med(),ciOrTmpl.getTimes()));
			}else{
				srvdto.setQuan_cur(calQuantumBP.getUnMMQuantum(ciOrTmpl.getDt_effe(),srvdto.getId_freq(), useDays, srvdto.getQuan_med()));
			}
			
			srvdto.setQuan_total_medu(srvdto.getQuan_cur());
		}
	}
	
	/**
	 * è®¡ç®—CiEmsSrvDTOä¸­çš„æ€»é‡
	 * 
	 * @param srvdto
	 *            æœåŠ¡é¡¹ç›®å¯¹è±¡
	 * @param useDays
	 *            ä½¿ç”¨å¤©æ•°
	 * @param orders
	 *            åŒ»å˜±ä»˜æ•°ï¼ˆè‰è¯ä½¿ç”¨ï¼‰
	 * @throws BizException
	 */
	private void setCiEmsSrvMeduPropertys(CiEnContextDTO envinfo,CiEmsSrvDTO srvdto, CiOrTmplDTO ciOrTmpl, CiEmsDTO ciEmsDto) throws BizException {
		
		Integer useDays=ciOrTmpl.getDays_or();
		Integer orders=ciOrTmpl.getOrders();

		useDays = useDays == null ? 1 : useDays;
		orders = orders == null ? 7 : orders;

		CalQuantumBP calQuantumBP = new CalQuantumBP();
		// å¦‚æœæ˜¯ç‰©å“ï¼Œé‡æ–°è·å–ç‰©å“å¯¹è±¡ TODO è®¡ç®—æ€»é‡
		if (FBoolean.TRUE.equals(srvdto.getFg_mm())) {
			// è®¡ç®—è¯å“æ€»é‡
			if (FBoolean.TRUE.equals(srvdto.getFg_dose_anoma())) { // å˜åŠ¨ç”¨è¯è®¡ç®—æ€»é‡
				GetDrugTotalQuan4DoseBP bp = new GetDrugTotalQuan4DoseBP();
				srvdto.setQuan_cur(new FDouble(bp.exec(srvdto, useDays)));
			} else {
				if (srvdto.getSd_srvtp().startsWith(IBdSrvDictCodeConst.SD_SRVTP_HERBDRUG)) {
					srvdto.setQuan_cur(calQuantumBP.getMMQuantum(envinfo.getCode_entp(), envinfo.getFg_pres_outp(), orders, srvdto.getId_mm(), srvdto.getId_unit_sale(), srvdto.getQuan_med()));
				}else{
					srvdto.setQuan_cur(calQuantumBP.getMMQuantum(envinfo.getCode_entp(), envinfo.getFg_pres_outp(), ciOrTmpl.getDt_effe(),useDays, srvdto.getId_freq(), srvdto.getId_mm(), srvdto.getId_unit_sale(), srvdto.getQuan_med()));
				}
				srvdto.setQuan_total_medu(srvdto.getQuan_cur());
			}
			// é¢†é‡å¤©æ•°
			srvdto.setDays_available(new GetDrugDaysOfAvailable().exec(srvdto));
		} else {
			// è®¡ç®—éè¯å“æœåŠ¡æ€»é‡
			if(ciEmsDto.getTimes_cur()!=null){
				srvdto.setQuan_cur(calQuantumBP.getQuantum(srvdto.getQuan_med(),ciEmsDto.getTimes_cur()));
			}else{
				srvdto.setQuan_cur(calQuantumBP.getUnMMQuantum(ciOrTmpl.getDt_effe(),srvdto.getId_freq(), useDays, srvdto.getQuan_med()));
			}
			
			srvdto.setQuan_total_medu(srvdto.getQuan_cur());
		}
	}

	/**
	 * è®¾ç½®CiEmsSrvDTOä¸­æ‰§è¡Œç§‘å®¤ç›¸å…³å±æ€?
	 * 
	 * @param srvdto
	 *            CiEmsSrv æœåŠ¡é¡¹ç›®
	 * @param envinfo
	 *            å½“å‰ç¯å¢ƒ
	 * @param medSrv
	 *            bdä¸­åŒ»ç–—æœåŠ¡å¯¹è±?
	 * @throws BizException
	 */
	private void setCiEmsSrvOrWfDept(CiEmsDTO ciEmsDto,CiEmsSrvDTO srvdto, CiEnContextDTO envinfo, MedSrvDO medSrv) throws BizException {
		if(srvdto == null || envinfo == null || medSrv ==null) {
			return;
		}
		String sd_srvtp = srvdto.getSd_srvtp();
		medSrv.setId_route(srvdto.getId_route());//ç”¨æ³•åº”è¯¥é‡‡ç”¨æ¨¡æ¿ä¼ æ¥çš„ï¼Œè€Œä¸æ˜¯bd_srvæŸ¥çš„
		//è·å–æ‰§è¡Œç§‘å®¤  ç§‘å®¤åœ¨è¿™é‡ŒæŒ‡è¯æˆ¿ é€šè¿‡ç±»å‹å­—æ®µåŒºåˆ†çš?
		OrWfDeptInfoDTO wf = DeptInfoUtils.GetOrWfDeptInfo(envinfo, medSrv.getId_srv(), srvdto.getId_mm(),ciEmsDto.getId_route(),ciEmsDto.getId_dep_mp(),ciEmsDto.getFg_long(),envinfo.getFg_pres_outp(),ciEmsDto.getDt_begin());
		if (null != wf) {
			List<GetStockReqDTO> reqDtos = new ArrayList<GetStockReqDTO>();
			if(sd_srvtp != null && sd_srvtp.startsWith(IBdSrvDictCodeConst.SD_SRVTP_DRUG)) {//è¯å“
				//1.åˆ¤æ–­ä¼˜å…ˆçº§æœ€é«˜çš„ä»“åº“æ˜¯å¦æœ‰åº“å­?
				constructConditions(reqDtos,srvdto,wf.getId_dept_wh());
				MaterialStockDTO materialDo = selectWhDept(reqDtos);
				setWhDept(srvdto,materialDo,wf.getName_dept_wh());
				String id_dep_wh = wf.getId_dept_wh();
				if(srvdto.getId_dep_wh() != null && srvdto.getName_dep_wh() != null) {//è‹¥ç¬¬ä¸€ä¼˜å…ˆçº§è¯æˆ¿é™„äº†å€? ç›´æ¥è¿”å›
					return ;
				}
				//2.è‹¥ä¼˜å…ˆçº§æœ€é«˜çš„æ²¡æœ‰åº“å­˜ï¼Œéå†å…¶ä»–ä¼˜å…ˆçº§çš„ä»“åº“ï¼Œä»ä¸­ä»»é€‰ä¸€ä¸?
				FArrayList idDeptWhs = wf.getPharmwfwhdepts();
				if(idDeptWhs != null && idDeptWhs.size() > 0) {
					reqDtos = new ArrayList<GetStockReqDTO>();
					Map<String,String> map = new HashMap<String,String>();
					for(int i=0;i<idDeptWhs.size();i++) {
						OrWfExDeptDTO orWfExDeptDTO = (OrWfExDeptDTO)idDeptWhs.get(i);
						map.put(orWfExDeptDTO.getId_dept(), orWfExDeptDTO.getName_dept());
						constructConditions(reqDtos,srvdto,orWfExDeptDTO.getId_dept());
					}
					materialDo = selectWhDept(reqDtos);
					if(materialDo != null ) {
						setWhDept(srvdto,materialDo,map.get(materialDo.getId_dep()));
					}
				}
			}else {
				srvdto.setId_dep_wh(wf.getId_dept_wh());
				srvdto.setName_dep_wh(wf.getName_dept_wh()); 
			}
		}
	}
	/**
	 * è®¾ç½®åº“æˆ¿å­—æ®µå€?
	 * @param srvdto
	 * @param materialDo
	 * @param deptName
	 */
	private void setWhDept(CiEmsSrvDTO srvdto,MaterialStockDTO materialDo,String deptName) {
		if(materialDo != null) {
			srvdto.setId_dep_wh(materialDo.getId_dep());
			srvdto.setName_dep_wh(deptName);
		}
	}
	/**
	 * æ„é€ æŸ¥è¯¢æ¡ä»¶dtos
	 * @param reqDtos
	 * @param srvdto
	 * @param id_dept
	 */
	private void constructConditions(List<GetStockReqDTO> reqDtos,CiEmsSrvDTO srvdto, String id_dept) {
		GetStockReqDTO reqDTO = new GetStockReqDTO();
		reqDTO.setId_mm(srvdto.getId_mm());//ç‰©å“id
		reqDTO.setId_dep(id_dept);//ç‰©èµ„ç§‘å®¤(åº“æˆ¿)
		reqDTO.setReq_unit_id(srvdto.getId_unit_sale());//é›¶å”®å•ä½
		reqDtos.add(reqDTO);
	}
	/**
	 * æŸ¥è¯¢è¯æˆ¿
	 * @param reqDtos
	 * @throws BizException
	 */
	private MaterialStockDTO selectWhDept(List<GetStockReqDTO> reqDtos) throws BizException{
		if(reqDtos == null || reqDtos.size() <= 0) {
			return null;
		}
		IMaterialStockService stoctService = CiOrdAppUtils.getMaterialStockQryService();
		MaterialStockDTO[] stockdto = null;
		try {
			stockdto = stoctService.getMaterialStocks(reqDtos.toArray(new GetStockReqDTO[0]));
		}catch(Exception e) {
			;
		}
		if (stockdto != null) {
			for (MaterialStockDTO materialDo : stockdto) {
				FDouble mmcount = materialDo.getQuan_usable();
				if (materialDo.getMmstatus() != MaterialStatus.NORELATION
						&& materialDo.getMmstatus() != MaterialStatus.STOP
						&& mmcount != null && (mmcount.compareTo(new FDouble(0)) != 0)
					) {
					return materialDo;
				}
			}
		}
		return null;
	}
	/**
	 * åˆ¤æ–­FDoubleç±»å‹æ•°æ®æ˜¯å¦ä¸ºç©º
	 * 
	 * @param doubleData
	 *            å¾…åˆ¤æ–­çš„æ•°æ®
	 * @return true doubleDataä¸ºç©ºï¼Œå¦åˆ™ä¸ä¸ºç©º
	 */
	private boolean isFDoubleEmpty(FDouble doubleData) {

		FDouble date1 = new FDouble(0.00000001);
		if (doubleData == null || date1.compareTo(doubleData) > 0) {
			return true;
		}
		return false;
	}

	/**
	 * è·å–ç‰©å“åŸºæœ¬åŒ…è£…å•ä½ä»·æ ¼
	 * 
	 * @param id_mm
	 *            ç‰©å“id
	 * @param id_unit_sale
	 *            ç‰©å“é›¶å”®å•ä½
	 * @return
	 */
	private FDouble getMMPrice(String id_mm, String id_unit_sale) throws BizException {
		IMaterialStockService service = ServiceFinder.find(IMaterialStockService.class);
		GetStockReqDTO reqDto = new GetStockReqDTO();
		reqDto.setId_mm(id_mm);
		reqDto.setReq_unit_id(id_unit_sale);
		GetStockReqDTO[] reqDtoArr = new GetStockReqDTO[1];
		reqDtoArr[0] = reqDto;
		MaterialStockDTO[] materials = service.getMaterialStocks(reqDtoArr);
		if (materials != null && materials.length > 0) {
			return materials[0].getPrice_act();
		} else {
			return null;
		}
	}

	/**
	 * è·å–ç‰©å“åŸºæœ¬åŒ…è£…å•ä½ä»·æ ¼
	 * 
	 * @param id_mm
	 *            ç‰©å“id
	 * @param id_unit_sale
	 *            ç‰©å“é›¶å”®å•ä½
	 * @return
	 */
	private FDouble getMMwhPrice(String id_mm, String id_unit_sale, String id_dep_wh) throws BizException {
		IMaterialStockService service = ServiceFinder.find(IMaterialStockService.class);
		GetStockReqDTO reqDto = new GetStockReqDTO();
		reqDto.setId_mm(id_mm);
		reqDto.setReq_unit_id(id_unit_sale);
		reqDto.setId_dep(id_dep_wh);
		GetStockReqDTO[] reqDtoArr = new GetStockReqDTO[1];
		reqDtoArr[0] = reqDto;
		MaterialStockDTO[] materials = service.getMaterialStocks(reqDtoArr);
		if (materials != null && materials.length > 0) {
			return materials[0].getPrice_act();
		} else {
			return null;
		}
	}

	/**
	 * åˆ›å»ºå¥—å†…é¡¹ç›®
	 * 
	 * @param envinfo
	 * @param ciOrTmpl
	 * @param medSrvDO
	 * @return
	 * @throws BizException
	 */
	private FMap createCiEmsSrvSetItems(CiOrTmplDTO ciOrTmpl) throws BizException {

		FMap fmap = null;
		if (!FBoolean.TRUE.equals(ciOrTmpl.getFg_set())) {
			return fmap;
		}

		// è·å–æ¨¡æ¿å¯¹åº”çš„å¥—å†…é¡¹ç›?
		MedSrvDO[] medSrvs = this.getSetMedSrvDOs(ciOrTmpl);

		return this.getSrvSetitmMap(ciOrTmpl.getId_srv(), medSrvs);
	}

	/**
	 * è·å–å¥—çš„mapç»“æœï¼?
	 * 
	 * @param idSrv
	 * @param medSrvs
	 * @return
	 */
	private FMap getSrvSetitmMap(String idSrv, MedSrvDO[] medSrvs) {

		FMap fmap = new FMap();
		FArrayList ordSrvSetList = new FArrayList();
		List<MedSrvSetItemDO> setItems = srvSetItemsMap.get(idSrv);
		if (setItems != null && setItems.size() > 0) {
			for (MedSrvSetItemDO setItem : setItems) {
				OrdSrvSetDO ordSrvSet = new OrdSrvSetDO();
				ordSrvSet.setStatus(DOStatus.NEW);
				ordSrvSet.setId_srvsetdef(setItem.getId_srv()); // æœåŠ¡å¥—id
				ordSrvSet.setId_srvset(setItem.getId_srv_itm()); // å¥—å†…é¡¹ç›®id
				ordSrvSet.setSortno(setItem.getSortno()); // æ’åºå?
				ordSrvSet.setDes_srv(setItem.getDes()); // å¥—å†…æœåŠ¡é¡¹ç›®æè¿°
				ordSrvSet.setId_srvsetrole(setItem.getId_srvsetrole()); // æˆå‘˜è§’è‰²
				ordSrvSet.setSd_srvsetrole(setItem.getSd_srvsetrole()); // æˆå‘˜è§’è‰²ç¼–ç 
				ordSrvSet.setId_medu(setItem.getId_medu()); // è®¡é‡å•ä½
				ordSrvSet.setQuan_medu(setItem.getQuan_medu()); // æ•°å€¼_åŒ»ç–—å•ä½
				ordSrvSet.setId_freqdef(setItem.getId_freq()); // é¢‘æ¬¡id
				MedSrvRisDO medSrvRis = srvRisMap.get(setItem.getId_srv_itm());
				if (!CiOrdUtils.isEmpty(medSrvRis)) {
					ordSrvSet.setBody_name(medSrvRis.getName_body());
					ordSrvSet.setId_body(medSrvRis.getId_body());
					ordSrvSet.setSd_body(medSrvRis.getSd_body());
					ordSrvSet.setId_pos(medSrvRis.getId_pos());
					ordSrvSet.setSd_pos(medSrvRis.getSd_pos());
				}
				// ordSrvSet.setSd_body( );

				ordSrvSetList.add(ordSrvSet);
			}
		}

		fmap.put(idSrv, ordSrvSetList);
		return fmap;
	}

	/**
	 * è·å–å¥—çš„å¥—å†…é¡¹ç›®æœåŠ¡é›†åˆ
	 * 
	 * @param ciOrTmpl
	 *            æ¨¡æ¿
	 * @return å¦‚æœæ¨¡æ¿ä¸­çš„é¡¹ç›®ä¸ºç©ºï¼Œè¿”å›å¥—å†…é¡¹ç›®ï¼Œå¦‚æœæ¨¡æ¿é€‰æ‹©äº†éƒ¨åˆ†å¥—å†…é¡¹ç›®ï¼ŒæŒ‰é€‰æ‹©çš„ç»“æœè¿”å›?
	 * @throws BizException
	 */
	private MedSrvDO[] getSetMedSrvDOs(CiOrTmplDTO ciOrTmpl) throws BizException {

		MedSrvDO[] medSrvs = null;
		FArrayList ortmplsrvs = ciOrTmpl.getOrtmplsrvs();
		if (OrSourceFromEnum.IIHCLINICALKITHELPER == ciOrTmpl.getEu_orsrcmdtp()
				&&FBoolean.TRUE.equals( ciOrTmpl.getFg_set())) {// æ¥æºç»„å¥—

			String whereStr = "id_srv in (select srvset.id_srv_itm from bd_srvset_def srvset where srvset.id_srv ='"
					+ ciOrTmpl.getId_srv() + "')";
			medSrvs = imedsrvMDORService.find(whereStr, null, FBoolean.FALSE);
		} else {
			List<String> idSrvList = new ArrayList<String>();
			for (Object obj : ortmplsrvs) {
				CiOrTmplSrvDTO setItem = (CiOrTmplSrvDTO) obj;
				idSrvList.add(setItem.getId_srv());
			}

			medSrvs = imedsrvMDORService.findByIds(idSrvList.toArray(new String[0]), FBoolean.FALSE);
		}

		return medSrvs;
	}

	/**
	 * è®¾ç½®CiEmsSrvDTO é¢‘æ¬¡ã€ç”¨æ³•ã€ç”¨æ³•è¦æ±‚ã€ç…æ³•ã€ç…æ³•è¦æ±?
	 * 
	 * @param ciEmsDto
	 * @param tmplSrvDTO
	 *            CiEmsDTO ciEmsDto
	 * @throws BizException
	 */
	private void setCiEmsSrvUseDetail(CiEmsSrvDTO srvdto, MedSrvDO medSrvDO) throws BizException {

		// é¢‘æ¬¡
		if (StringUtils.isBlank(srvdto.getId_freq())) {
			throw new BizException("é¢‘æ¬¡ä¸èƒ½ä¸ºç©ºï¼?);
		}

		FreqDefDO freqDef = ifreqdefMDORService.findById(srvdto.getId_freq());
		if (freqDef == null) {
			throw new BizException("è·å–é¢‘æ¬¡SDå¤±è´¥ï¼?);
		}
		srvdto.setId_freq(freqDef.getId_freq());
		srvdto.setName_freq(freqDef.getName());// åŒ»å˜±é¢‘æ¬¡åç§°
		srvdto.setFreqct(freqDef.getFreqct()); // é¢‘æ¬¡å‘¨æœŸä¸‹æ¬¡æ•?
		srvdto.setSd_frequnitct(freqDef.getSd_frequnitct()); // é¢‘æ¬¡å‘¨æœŸç¼–ç 
		srvdto.setFrequnitct(freqDef.getFreqct());// TODO é¢‘æ¬¡å‘¨æœŸæ•°ï¼Œä½¿ç”¨æ··æ·†

		// è®¾ç½®ç”¨æ³•idã€åç§?
		if (StringUtils.isNotBlank(srvdto.getId_route())) {

			// MedUsageDO medUsage =
			// imedusageRService.findById(srvdto.getId_route()); // ç”¨æ³•
			DAFacade dafa = new DAFacade();
			String sql = "select name from bd_route where id_route='" + srvdto.getId_route() + "'";
			MedUsageDO medUsage = (MedUsageDO) dafa.execQuery(sql, new BeanHandler(MedUsageDO.class));
			if (medUsage == null) {
				throw new BizException("è·å–ç”¨æ³•SDå¤±è´¥ï¼?);
			}
			srvdto.setName_route(medUsage.getName());// ç”¨æ³•åç§°
		} else {
			srvdto.setId_route(medSrvDO.getId_route());// ç”¨æ³•
			srvdto.setName_route(medSrvDO.getRoute_name());// ç”¨æ³•åç§°
		}

		// ç”¨æ³•è¦æ±‚ï¼Œè®¾ç½®ç”¨æ³•è¦æ±‚idã€åç§?
		if (StringUtils.isNotBlank(srvdto.getId_routedes())) {
			srvdto.setName_routedes(this.getName_routes(srvdto.getId_routedes()));
		} else {
			srvdto.setId_routedes(medSrvDO.getId_routedes());
			srvdto.setName_routedes(medSrvDO.getRoutedes_name());
		}

		// è®¾ç½®ç…æ³•idã€åç§?
		if (StringUtils.isNotBlank(srvdto.getId_boil())) {
			CHerbBoilMdDO cHerbBoilMd = icherbboilmdMDORService.findById(srvdto.getId_boil());
			if (cHerbBoilMd == null) {
				throw new BizException("è·å–ç…æ³•SDå¤±è´¥ï¼?);
			}
			srvdto.setName_boil(cHerbBoilMd.getName());
		} else {
			srvdto.setId_boil(medSrvDO.getId_boil());
			srvdto.setName_boil(medSrvDO.getBoil_name());
		}

		// ç…æ³•è¦æ±‚
		if (StringUtils.isNotBlank(srvdto.getId_boildes())) {
			CHerbBoilDesDO cherbBoilDes = icHerbBoilDesDORService.findById(srvdto.getId_boildes());
			if (cherbBoilDes == null) {
				throw new BizException("è·å–ç…æ³•è¦æ±‚SDå¤±è´¥ï¼?);
			}
			srvdto.setName_boildes(cherbBoilDes.getName());
		} else {
			srvdto.setId_boildes(medSrvDO.getId_boildes());
			srvdto.setName_boildes(medSrvDO.getBoildes_name());
		}
	}

	/**
	 * åŒ»ç–—å•åŒ¹é…?
	 * 
	 * @param envinfo
	 * @param medSrvDO
	 * @return
	 * @throws BizException
	 */
	private SrvMatchEmsRstDTO getFuncClassStr(CiEnContextDTO envinfo, MedSrvDO medSrvDO) throws BizException {
		return CiOrdUtils.getFuncClassStr_GJ(envinfo, medSrvDO);
	}

	/**
	 * æŸ¥è¯¢æ‰§è¡Œç§‘å®¤ï¼Œä¸åŒ…å«ç‰©è´¨æµå‘
	 * 
	 * @param envinfo
	 *            å°±è¯Šç¯å¢ƒ
	 * @param medsrvDO
	 *            å½“å‰æœåŠ¡
	 * @return
	 * @throws BizException
	 */
	private OrWfDeptInfoDTO getMpDeptID(CiEnContextDTO envinfo, CiEmsDTO ciEms,MedSrvDO medsrvDO) throws BizException {
		OrWfDeptInfoDTO wf = DeptInfoUtils.GetOrWfDeptInfo(envinfo, medsrvDO.getId_srv(), null, ciEms.getId_route(),ciEms.getId_dep_mp(), ciEms.getFg_long(), ciEms.getFg_pres_outp(),ciEms.getDt_begin());

		return wf;
	}

	/**
	 * ä¸€æ¬¡æ€§æŸ¥è¯¢bd_srv æ•°æ®
	 * 
	 * @param ciOrtmplAggDTO
	 * @return
	 * @throws BizException
	 */
	private Map<String, MedSrvDO> OptimizationMedSrvDO(CiOrTmplDTO[] ciOrtmplAggDTO) throws BizException {
		MedSrvDO[] medsrvDo = null;
		if (ciOrtmplAggDTO != null && ciOrtmplAggDTO.length > 0) {
			List<String> list = new ArrayList<String>();
			for (CiOrTmplDTO ciOrtmplDTO : ciOrtmplAggDTO) {
				if (ciOrtmplDTO.getId_srv() == null || ciOrtmplDTO.getId_srv() == "")
					continue;
				list.add(ciOrtmplDTO.getId_srv());
			}
			if (list != null && list.size() > 0) {
				String[] id_srv = list.toArray(new String[0]);
				medsrvDo = findByIds(id_srv, FBoolean.FALSE);
			}
		}
		return medSrvDOMap(medsrvDo);
	}

	/**
	 * æŸ¥è¯¢bd_srv
	 * 
	 * @param Id_srv
	 * @param IsLazy
	 * @return
	 * @throws BizException
	 */
	private MedSrvDO[] findByIds(String[] Id_srv, FBoolean IsLazy) throws BizException {
		return imedsrvMDORService.findByIds(Id_srv, IsLazy);
	}

	/**
	 * MedsrvDO[] è½¬æ¢æˆ?map
	 * 
	 * @param medsrvDo
	 * @return
	 */
	private Map<String, MedSrvDO> medSrvDOMap(MedSrvDO[] medsrvDo) {
		Map<String, MedSrvDO> map = new HashMap<String, MedSrvDO>();
		if (medsrvDo == null)
			return null;
		for (MedSrvDO medsrvDO : medsrvDo) {
			map.put(medsrvDO.getId_srv(), medsrvDO);
		}
		return map;
	}

	/**
	 * CiEmsDTOæ‰§è¡Œå±æ€§æ˜ å°„åçš„è®¾ç½?
	 * 
	 * @param ctx
	 *            å½“å‰å°±è¯Šç¯å¢ƒ
	 * @param ciEms
	 *            CiEmsDTOå¯¹è±¡
	 * @throws BizException
	 */
	private void afterFieldMapping(CiEnContextDTO ctx, CiEmsDTO ciEms) throws BizException {

		MedSrvDO medSrv = bdSrvMap.get(ciEms.getId_srv());

		FArrayList emSrvList = ciEms.getEmssrvs();
		CiEmsSrvDTO firstCiEmsSrv = (CiEmsSrvDTO) emSrvList.get(0);
		//å¦‚æœåŒ»å˜±æ¨¡æ¿é…ç½®çš„ç§‘å®¤åœ¨æ‰§è¡Œæµå‘é‡Œï¼Œå–æ¨¡æ¿é…ç½®çš„ç§‘å®¤
		OrWfDeptInfoDTO orWfDeptInfo =null;
		orWfDeptInfo = getMpDeptID(ctx, ciEms,medSrv);
		if (null != orWfDeptInfo) {
			if(ciEms.getId_dep_mp()!=null) {
	            Boolean flag=false;
				for (Object d : orWfDeptInfo.getOrwfexedepts()) {
					OrWfExDeptDTO dp=(OrWfExDeptDTO)d;
					if(ciEms.getId_dep_mp().equals(dp.getId_dept())) {
						ciEms.setName_dep_mp(dp.getName_dept());
						flag=true;
						break;
					}
						
				}
				if(!flag)
			   {
				   ciEms.setId_dep_mp(orWfDeptInfo.getFirstid_mp_dept());
				   ciEms.setName_dep_mp(orWfDeptInfo.getFirstname_mp_dept());
			    }
			}else {
				ciEms.setId_dep_mp(orWfDeptInfo.getFirstid_mp_dept());
				ciEms.setName_dep_mp(orWfDeptInfo.getFirstname_mp_dept());
			}
			
		}
		// æ ¹æ®æ£€æŸ¥å±æ€§ä¸­çš„æ˜¯å¦åºŠè¾¹æ‰§è¡Œå±æ€§è®¾ç½®åºŠæ—æ‰§è¡Œå±æ€?
		MedSrvRisDO medSrvRis = srvRisMap.get(ciEms.getId_srv());
		if (medSrvRis != null && FBoolean.TRUE.equals(medSrvRis.getIf_mp_bed())) {
			ciEms.setFg_mp_bed(FBoolean.TRUE);
		} else {
			ciEms.setFg_mp_bed(FBoolean.FALSE);
		}
		// è®¾ç½®çš®è¯•åŒ»å˜±æ ‡è¯† ,0506è®¾ç½®çš®è¯•æ ‡è¯†ä¸ºY
		if (IBdSrvDictCodeConst.SD_SRVTP_TREAT_SKINMINGANTEST.equals(medSrv.getSd_srvtp())) {
			ciEms.setFg_skintest(FBoolean.TRUE);
		}
		
		// è®¾ç½®æœåŠ¡é¡¹ç›®ä¸­çš„æ‰§è¡Œç§‘å®¤
		for (Object obj : emSrvList) {			
			CiEmsSrvDTO ciEmsSrv = (CiEmsSrvDTO) obj;
			ciEmsSrv.setId_dep(ciEms.getId_dep_mp());
			ciEmsSrv.setName_dep(ciEms.getName_dep_mp());

		}
		
	}

	
	/**
	 * æ‹¼æ¥keyå…³é”®å­?
	 * 
	 * @param id_mm
	 * @param id_dep_wh
	 * @param id_unit_sale
	 * @return
	 */
	private String getKeyId(String id_mm, String id_dep_wh, String id_unit_sale) {
		return (id_mm == null ? "" : id_mm) + (id_dep_wh == null ? "" : id_dep_wh)
				+ (id_unit_sale == null ? "" : id_unit_sale);
	}

	/**
	 * åŒ»å˜±æ¨¡æ¿ä¿å­˜æ ¡éªŒåº“å­˜
	 * 
	 * @param paramsMap
	 * @param mapEmsDto
	 * @param delEmsDTOs
	 * @return
	 * @throws BizException
	 */
	public String validateDrugCount(Map<String, String[]> paramsMap, Map<String, CiEmsDTO> mapEmsDto,
			List<CiEmsDTO> delEmsDTOs) throws BizException {
		String nocount = "";// æ— åº“å­?
		String stopSale = "";// åœå‘
		String noDrug = "";// æ— æ­¤è?
		List<GetStockReqDTO> reqDtos = new ArrayList<GetStockReqDTO>();
		for (Map.Entry<String, String[]> map : paramsMap.entrySet()) {
			GetStockReqDTO reqDTO = new GetStockReqDTO();
			reqDTO.setId_mm(map.getValue()[0]);
			reqDTO.setId_dep(map.getValue()[1]);
			reqDTO.setReq_unit_id(map.getValue()[2]);
			reqDtos.add(reqDTO);
		}
		if (reqDtos.size() > 0) {
			IMaterialStockService stoctService = CiOrdAppUtils.getMaterialStockQryService();
			MaterialStockDTO[] stockdto = null;
			stockdto = stoctService.getMaterialStocks(reqDtos.toArray(new GetStockReqDTO[0]));
			if (stockdto != null) {
				String mmcounterror = "";
				for (MaterialStockDTO materialDo : stockdto) {
					String key = this.getKeyId(materialDo.getId_mm(), materialDo.getId_dep(),
							materialDo.getReq_unit_id());
					String[] param = paramsMap.get(key);
					FDouble mmcount = materialDo.getQuan_usable();
					// è¯æˆ¿æ— æ­¤è¯çš„ç§»é™¤
					if (materialDo.getMmstatus() == MaterialStatus.NORELATION) {
						noDrug += param[3] + ",";
						if (mapEmsDto.containsKey(key)) {
							delEmsDTOs.add(mapEmsDto.get(key));
						}
					} else if (materialDo.getMmstatus() == MaterialStatus.STOP) {
						stopSale += param[3] + ",";
						if (mapEmsDto.containsKey(key)) {
							delEmsDTOs.add(mapEmsDto.get(key));
						}
					} else if (mmcount.compareTo(new FDouble(param[4])) < 0) {
						nocount += param[3] + ",";
						if (mapEmsDto.containsKey(key)) {
							delEmsDTOs.add(mapEmsDto.get(key));
						}
					}
				}
				if (!CiOrdUtils.isEmpty(noDrug)  && !mmcounterror.contains(noDrug)) {
					mmcounterror = "æœåŠ¡ï¼? + noDrug.substring(0, noDrug.length() - 1) + "ï¼Œè¯æˆ¿æ— æ­¤è¯ï¼\r\n";
				}
				if (!CiOrdUtils.isEmpty(stopSale)  && !mmcounterror.contains(stopSale)) {
					mmcounterror += mmcounterror + "æœåŠ¡ï¼? + stopSale.substring(0, stopSale.length() - 1) + "ï¼Œå·²åœå¼€ï¼\r\n";
				}
				if (!CiOrdUtils.isEmpty(nocount) && !mmcounterror.contains(nocount)) {
					mmcounterror += mmcounterror + "æœåŠ¡ï¼? + nocount.substring(0, nocount.length() - 1) + "ï¼Œåº“å­˜ä¸è¶³ï¼";
				}
				if (CiOrdUtils.isEmpty(mmcounterror))
					return null;
				return mmcounterror;
			}
		}
		return null;
	}

	private String getName_routes(String id_routdes) throws BizException {
		if (CiOrdUtils.isEmpty(id_routdes))
			return null;
		String[] idStr = id_routdes.split(",");
		MedUsageDesDO[] usageDes = imedusagedesRService.findByBIds(idStr, FBoolean.FALSE);
		if (usageDes == null) {
			throw new BizException("è·å–ç”¨æ³•è¦æ±‚SDå¤±è´¥ï¼?);
		}
		String UsageDesNames = "";
		for (MedUsageDesDO usagedes : usageDes) {
			UsageDesNames += usagedes.getName() + ",";
		}
		if (UsageDesNames.length() > 0) {
			return UsageDesNames.substring(0, UsageDesNames.length() - 1);
		}
		return null;
	}
}